PROMPT

Stiamo lavorando al Gestionale Infrazioni Irrigue (CBSM) basato su ArcGIS Online + Survey123 + ArcGIS Experience Builder Developer Edition 1.19 + (in futuro) gestione casi particolari con creazione pratica da gestionale.

0) Contesto e ambiente

Ambiente: ArcGIS Experience Builder Dev Edition 1.19 (Windows)

Percorsi tipici:

ExB: C:\ESRI\arcgis-experience-builder-1.19\

Repo: D:\GitHub\Progetti\gestionale-infrazioni-exb-dev

App locale in ExB: apps/0

Organizzazione AGOL: cbsm-hub.maps.arcgis.com

Feature Service principale (Hosted Feature Layer):

Service: service_da9d790b10de4f2c82155df52d577055

Layer 0: Rapporto_di_rilevazione_infrazioni_irrigue

URL layer: https://services2.arcgis.com/vH5RykSdaAwiEGOJ/arcgis/rest/services/service_da9d790b10de4f2c82155df52d577055/FeatureServer/0

ItemId: 7d298cf936d841bd931470d2b1b60047

1) Survey123 (raccolta in campo)

Survey123:

Nome survey: “Rapporto di rilevazione infrazioni irrigue”

Feature layer ospitato: “Rapporto di rilevazione infrazioni irrigue”

XLS form: “Rapporto di rilevazione infrazioni irrigue.xlsx”

CSV supporto: “utenti.csv” (usato dal form per pulldata/lookup utente → area/settore/ufficio/ruolo ecc.)

Le foto/allegati del rilevamento arrivano come attachments del feature layer.

2) Web map e oggetti AGOL in uso

Cartella AGOL: “Survey-Rapporto di rilevazione infrazioni irrigue” (attualmente usata da survey + gestionale).
Contenuti principali:

Form Survey: “Rapporto di rilevazione infrazioni irrigue”

Feature layer: “Rapporto di rilevazione infrazioni irrigue”

Web map: “Rapporto di rilevazione_Editing_map” (usata anche come datasource principale in EB per editing)

Viste (Hosted Views) in uso:

GII_VIEW_EB_BASE (nessun filtro)

GII_VIEW_EB_AGR (area_cod = AGR)

GII_VIEW_EB_TEC (area_cod = TEC)

GII_VIEW_EB_TEC_DS (area_cod = TEC AND settore_cod = DS)

GII_VIEW_EB_AMM_ALL (nessun filtro)

GII_VIEW_EB_AGR_D1..D6 (area_cod = AGR AND settore_cod = D1..D6)

GII_VIEW_TR (vista editabile per TR; condivisione a gruppi TR AGR D1..D6)

GII_AGR_DIR_view (vista editabile per DT Area AGR; filtro area_cod = AGR; update solo attributi)

(inoltre esistono viste “_form” e “_results” legate a Survey123)

Nota: in passato ho archiviato viste obsolete nella cartella ZZ_ARCHIVIO_VISTE_OLD (non vanno considerate attive).

3) Campi principali del layer (estratto ragionato)

Nel layer Rapporto_di_rilevazione_infrazioni_irrigue ci sono:

Identificativi: objectid, globalid

Dati rilevamento: start, end, data_rilevazione, tecnico_rilevatore, ufficio_zona, descrizione_luogo

Dati soggetto: tipologia_soggetto, nome, cognome, ragione_sociale, codice_fiscale, piva, via, civico, citta, cap, email, pec, telefono, cellulare

Dati violazione (molti campi): es. tipo_prelievo, norma15_parziale, norma15_totale, norma16_17, art17_tipo, superfici, check articoli (v_art08, v_art12, …), descrizione_fatti, circostanze, presenza_trasgressore, ecc.

Smistamento/contesto organizzativo:

area_cod può essere AGR / TEC / AMM

settore_cod identifica distretto/settore:

AGR: D1..D6

TEC: DS

AMM: CR (Catasto/Ruoli/Servizi territoriali, semplificato)

Workflow tecnico (campi stato e note):

stato_TR, stato_TI, stato_RZ, stato_RI, stato_DT, stato_DA

dt_stato_TR, dt_stato_TI, dt_stato_RZ, dt_stato_RI, dt_stato_DT, dt_stato_DA

note_TI, note_RZ, note_RI, note_DT, note_DA

prese in carico ed esiti direttori:

presa_in_carico_DT (1=Da prendere in carico, 2=Presa in carico)

dt_presa_in_carico_DT

esito_DT (1=Integrazione richiesta, 2=Approvata, 3=Respinta)

dt_esito_DT

presa_in_carico_DA, dt_presa_in_carico_DA

esito_DA (1=Integrazione richiesta, 2=Approvata, 3=Respinta)

dt_esito_DA

Campi “utility” già presenti: GII_da, GII_a, GII_dt, flag GII_rim, GII_trasm, GII_arch, ecc.

4) NUOVO campo richiesto: origine_pratica

Voglio introdurre un campo origine_pratica (intero):

1 = TR (pratica nata da Survey123 in campagna)

2 = TI (pratica creata direttamente dal gestionale / pagina di editing)

Regole:

Alla creazione via Survey123 → origine_pratica = 1 (automatico)

Alla creazione via Gestionale (TI) → origine_pratica = 2 (automatico)

5) Ruoli e gruppi AGOL (nomenclatura)

Ruoli “tecnici” comuni alle aree AGR/TEC: TR, TI, RZ, RI, DT (con DT = Direttore “tecnico” sia AGR che TEC).
Ruoli “amministrativi”: DA (Direttore Area Amministrativa) + TI AMM + RI AMM (attenzione: in AMM manca RZ, NON manca RI).

Gruppi (principali):

AGR distretti D1..D6:

GII_AGR_Dx_TR, GII_AGR_Dx_TI, GII_AGR_Dx_RZ

AGR (ruoli trasversali):

GII_AGR_RI

GII_AGR_DIR (DT area AGR)

TEC distretto DS:

GII_TEC_DS_TR, GII_TEC_DS_TI, GII_TEC_DS_RZ

TEC (ruoli trasversali):

GII_TEC_RI

GII_TEC_DIR (DT area TEC)

AMM:

GII_AMM_DIR (DA)

GII_AMM_TI (TI fase sanzionatoria)

GII_AMM_RI (RI fase sanzionatoria)

Nota importante sul RI e TI amministrativi:
Non chiamarli “RI_AMM” e "TI_AMM" (non sono nomi campi): sono sempre RI e TI ma con area_cod = AMM.

6) Workflow aggiornato (tecnico + amministrativo)

Obiettivo: workflow robusto, tracciabile e difendibile in contenzioso.

6.1 Workflow TECNICO per pratiche AGR/TEC nate da TR (origine_pratica = 1)

TR (campagna, Survey123) crea e invia il rapporto
→ la pratica deve essere indirizzata prima a RZ (non direttamente a TI) per evitare che con più TI nessuno prenda in carico.

RZ prende in carico e assegna a uno specifico TI (dello stesso ufficio/settore).

TI prende in carico, istruisce (integrazioni, correzioni dati, ecc.) e rimanda a RZ.

RZ decide:

o rimanda indietro al TI (integrazione richiesta),

oppure manda avanti al RI.

RI istruisce/valida e manda avanti al DT dell’area di competenza (DT vede solo i record della propria area tramite area_cod).

DT prende in carico ed esprime esito tecnico (approva/respinge/integrazione), e se approva trasmette al DA (fase sanzionatoria).

6.2 Workflow TECNICO per pratiche create dal TI in ufficio (origine_pratica = 2)

Caso: alcune casistiche non nascono da survey in campo.

TI crea una nuova pratica direttamente nel gestionale (pagina di editing)
→ origine_pratica = 2

Non serve assegnazione iniziale di RZ (perché l’ha creata già un TI).
Il RZ interviene quando il TI gli rimanda la pratica per andare avanti/indietro.

Da qui in poi il flusso segue la stessa logica: TI → RZ → RI → DT → DA (con possibilità di integrazioni).

Mini-tabella “a colpo d’occhio” (differenza ruolo RZ in base a origine_pratica)
origine_pratica	Chi crea	Primo “nodo” operativo	Ruolo RZ
1	TR (Survey123)	RZ	RZ assegna a TI + gestisce avanti/indietro
2	TI (gestionle)	TI	RZ non assegna (TI già noto), fa solo avanti/indietro dopo istruttoria
6.3 Workflow AMMINISTRATIVO (fase sanzionatoria) – top-down

In AMM manca RZ, sono coinvolti DA → RI amministrativo → TI amministrativo.

DA riceve tutti i rapporti approvati dai DT (sia AGR che TEC) e gestisce la fase sanzionatoria.

DA può inoltrare al RI amministrativo (controllo sanzionatorio/istruttoria amministrativa).

RI amministrativo può inoltrare/assegnare al TI AMM (produzione atti / istruttoria operativa).

Rientri e integrazioni avvengono sempre “dall’alto verso il basso” e ritorno.

6.4 Eccezione fondamentale (bypass direttori in fase sanzionatoria)

Può succedere che in fase sanzionatoria (RI o TI AMM) rilevino errori/integrazioni necessarie sui dati tecnici.
In questo caso:

Il RI amministrativo deve poter dialogare direttamente col RI dell’area di provenienza (AGR o TEC), senza passare da DT/DA.

Quindi deve esistere un “canale” RI↔RI (AMM ↔ AGR/TEC) per richieste/risposte e correzioni mirate.

7) Stato pratica e regole (linee guida)

Per ciascun ruolo esistono campi stato_*, dt_stato_*, note_*.
I campi del record rappresentano lo stato attuale, ma non sono sufficienti a ricostruire uno storico completo (perché i passaggi successivi sovrascrivono).

8) Storicizzazione “blindata” (scelta: Webhooks + tabella log)

Voglio una soluzione molto forte per difesa in contenzioso: lo storico deve essere append-only e difficilmente contestabile.

Scelta preferita: ArcGIS Feature Service Webhooks (anche se con ritardo ~1 minuto va bene) che inviano gli eventi a un endpoint (es. Power Automate / Azure Function) e scrivono in una tabella log.

Richiesta:

Proponi un’architettura Webhooks → Flow/Function → Tabella Log con i campi minimi necessari.

Il log deve registrare ogni passaggio e ogni modifica rilevante: chi, quando, cosa, da quale stato a quale stato, e (se possibile) elenco campi modificati.

Il log non deve dipendere solo dall’editor tracking del record (che non è sufficiente come “catena storica” completa).

Deve essere possibile ricostruire l’intero iter storico di una pratica partendo da globalid (o objectid) del record principale.

9) Experience Builder – Custom widgets (già sviluppati e da estendere)

Abbiamo già due custom widget principali:

9.1 Widget elenco

Nome widget: gii-elenco-pratiche-pro

Funzione: elenco pratiche con selezione record; UI curata (zebra, badge, ordinamenti/filtri, ecc.).

Datasource multipla / data views.

9.2 Widget azioni (DT/DA)

Nome widget: gii-azioni-dir-agr (il nome storico include “dir-agr”, ma concettualmente è il widget Azioni per DT/DA)

Tabs: Anagrafica, Violazione, Iter, Allegati, Azioni

Esiste una logica di “lock procedura” per evitare azioni parziali / perdita modifiche:

finché non confermo/annullo l’azione, non devo “sporcare” il resto

Gestisce applyEdits e messaggi UX coerenti (success/error, no selection, ecc.)

Tab Allegati: apertura allegati via URL, con pulsante “Aggiorna” manuale.

10) Stato attuale sviluppo (focus DT, area AGR)

Per ora stiamo sviluppando il lato DT (area AGR) usando:

Feature service: GII_AGR_DIR_view

Layer base: Rapporto_di_rilevazione_infrazioni_irrigue

Data Views / datasource usate nei widget (lato DT):

F_AGR_DIR_TUTTE (nessun filtro)

F_AGR_DIR_DA_PRENDERE (presa_in_carico_DT = “Da prendere in carico”)

F_AGR_DIR_IN_ATTESA_ESITO (presa_in_carico_DT = “Presa in carico” AND esito_DT vuoto)

F_AGR_DIR_TRASMESSE (esito_DT = “Approvata”)
Attualmente i custom widget usano (almeno) queste datasource:

F_AGR_DIR_TUTTE

F_AGR_DIR_DA_PRENDERE

F_AGR_DIR_IN_ATTESA_ESITO

11) Obiettivi della nuova fase (cosa devi fare tu in questa chat)

Consolidare formalmente il workflow completo con:

origine_pratica (1 TR / 2 TI)

differenza operativa del ruolo RZ in base all’origine

flusso AMM top-down (DA → RI amministrativo → TI AMM)

eccezione RI↔RI (AMM ↔ AGR/TEC) bypass direttori

Definire la soluzione “blindata” di storicizzazione:

creazione tabella log correlata o tabella standalone con chiave verso globalid

configurazione Webhooks sul feature service (create/update) → endpoint → insert log

struttura record di log e come ricostruire timeline

Indicazioni operative su:

quali campi aggiungere/adeguare nel layer (origine_pratica, eventuali campi supporto)

eventuali regole/calcoli in Survey123 per valorizzare origine_pratica=1

eventuale logica nel gestionale per valorizzare origine_pratica=2

Suggerire come gestire la differenziazione visuale/filtri (viste/datasource) per:

pratiche nate da TR vs TI

assegnazione RZ→TI solo quando origine_pratica=1

Tenere tutto il più possibile compatibile con quanto già sviluppato nei custom widget (evitare rifacimenti).

Se ti serve, posso incollare anche:

estratto utenti.csv (colonne e significato)

elenco completo campi o domini stati

zip dei widget aggiornati

Nota importante sul tono/approccio

Non proporre di “rifare da zero”. Dobbiamo salvare il più possibile di quanto già realizzato. Ogni modifica deve essere minimal e motivata, perché il sistema è in produzione/validazione e dobbiamo evitare regressioni.

Se vuoi, puoi partire rispondendo così:

Schema workflow definitivo (con diagramma testuale)

Disegno tabella log + campi + esempio record

Piano Webhooks (eventi, payload, flow)

Impatti minimi su layer + Survey + gestionale

Fine prompt.