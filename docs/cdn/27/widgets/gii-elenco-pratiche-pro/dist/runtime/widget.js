System.register(["jimu-core/emotion","jimu-core","jimu-ui"],function(e,t){var i={},r={},a={};return{setters:[function(e){i.Fragment=e.Fragment,i.jsx=e.jsx,i.jsxs=e.jsxs},function(e){r.DataSourceComponent=e.DataSourceComponent,r.DataSourceManager=e.DataSourceManager,r.DataSourceStatus=e.DataSourceStatus,r.Immutable=e.Immutable,r.React=e.React,r.css=e.css},function(e){a.Button=e.Button,a.Loading=e.Loading}],execute:function(){e((()=>{var e={244:e=>{"use strict";e.exports=r},321:e=>{"use strict";e.exports=a},386:e=>{"use strict";e.exports=i}},t={};function o(i){var r=t[i];if(void 0!==r)return r.exports;var a=t[i]={exports:{}};return e[i](a,a.exports,o),a.exports}o.d=(e,t)=>{for(var i in t)o.o(t,i)&&!o.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},o.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),o.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},o.p="";var n={};return o.p=window.jimuConfig.baseUrl,(()=>{"use strict";o.r(n),o.d(n,{__set_webpack_public_path__:()=>R,default:()=>j});var e=o(386),t=o(244),i=o(321);const r=[{id:"col_pratica",label:"N. pratica",field:"objectid",width:120},{id:"col_data",label:"Data rilev.",field:"data_rilevazione",width:150},{id:"col_stato",label:"Stato sintetico",field:"__stato_sint__",width:220},{id:"col_ufficio",label:"Ufficio",field:"ufficio_zona",width:170},{id:"col_ultimo",label:"Ultimo agg.",field:"__ultimo_agg__",width:170},{id:"col_prossima",label:"Prossima azione",field:"__prossima__",width:240}],a=(0,t.Immutable)({filterTabs:[],columns:r,orderByField:"objectid",orderByDir:"DESC",fieldPratica:"objectid",fieldDataRilevazione:"data_rilevazione",fieldUfficio:"ufficio_zona",fieldPresaDT:"presa_in_carico_DT",fieldDtPresaDT:"dt_presa_in_carico_DT",fieldStatoDT:"stato_DT",fieldDtStatoDT:"dt_stato_DT",fieldEsitoDT:"esito_DT",fieldDtEsitoDT:"dt_esito_DT",fieldPresaDA:"presa_in_carico_DA",fieldDtPresaDA:"dt_presa_in_carico_DA",fieldStatoDA:"stato_DA",fieldDtStatoDA:"dt_stato_DA",fieldEsitoDA:"esito_DA",fieldDtEsitoDA:"dt_esito_DA",presaDaPrendereVal:1,presaPresaVal:2,labelPresaDaPrendere:"Da prendere in carico",labelPresaPresa:"Presa in carico",statoDaPrendereVal:1,statoPresaVal:2,statoIntegrazioneVal:3,statoApprovataVal:4,statoRespintaVal:5,labelStatoDaPrendere:"Da prendere",labelStatoPresa:"Presa in carico",labelStatoIntegrazione:"Integrazione richiesta",labelStatoApprovata:"Approvata",labelStatoRespinta:"Respinta",esitoIntegrazioneVal:1,esitoApprovataVal:2,esitoRespintaVal:3,labelEsitoIntegrazione:"Integrazione richiesta",labelEsitoApprovata:"Approvata",labelEsitoRespinta:"Respinta",whereClause:"1=1",pageSize:200,showHeader:!0,headerPratica:"N. pratica",headerData:"Data rilev.",headerUfficio:"Ufficio",headerStato:"Stato sintetico",headerUltimoAgg:"Ultimo agg.",headerProssima:"Prossima azione",paddingLeftFirstCol:0,gap:12,colWidths:{pratica:120,data:150,stato:220,ufficio:170,ultimo:170,prossima:240},rowGap:8,rowPaddingX:12,rowPaddingY:10,rowMinHeight:44,rowRadius:12,rowBorderWidth:1,rowBorderColor:"rgba(0,0,0,0.08)",zebraEvenBg:"#ffffff",zebraOddBg:"#fbfbfb",hoverBg:"#f2f6ff",selectedBg:"#eaf2ff",selectedBorderColor:"#2f6fed",selectedBorderWidth:2,emptyMessage:"Nessun record trovato (view/filtro/permessi).",errorNoDs:"Configura la fonte dati del widget.",statoChipRadius:999,statoChipPadX:10,statoChipPadY:4,statoChipBorderW:1,statoChipFontWeight:600,statoChipFontSize:12,statoChipFontStyle:"normal",statoChipTextTransform:"none",statoChipLetterSpacing:0,statoBgDaPrendere:"#fff7e6",statoTextDaPrendere:"#7a4b00",statoBorderDaPrendere:"#ffd18a",statoBgPresa:"#eaf7ef",statoTextPresa:"#1f6b3a",statoBorderPresa:"#9ad2ae",statoBgAltro:"#f2f2f2",statoTextAltro:"#333333",statoBorderAltro:"#d0d0d0",maskOuterOffset:12,maskInnerPadding:8,maskBg:"#ffffff",maskBorderColor:"rgba(0,0,0,0.12)",maskBorderWidth:1,maskRadius:12,listTitleText:"Elenco rapporti di rilevazione",listTitleHeight:28,listTitlePaddingBottom:10,listTitlePaddingLeft:0,listTitleFontSize:14,listTitleFontWeight:600,listTitleColor:"rgba(0,0,0,0.85)"});var l=function(e,t,i,r){return new(i||(i=Promise))(function(a,o){function n(e){try{s(r.next(e))}catch(e){o(e)}}function l(e){try{s(r.throw(e))}catch(e){o(e)}}function s(e){var t;e.done?a(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(n,l)}s((r=r.apply(e,t||[])).next())})};function s(e){return new Promise((t,i)=>{const r=window.require;if(r)try{r([e],e=>t(e),e=>i(e))}catch(e){i(e)}else i(new Error("AMD require non disponibile"))})}const d="__stato_sint__",c="__ultimo_agg__",u="__prossima__";function f(e,t){const i=Number(e);return Number.isFinite(i)?i:t}function p(e){return null==e?"":String(e)}function g(e){return(null==e?void 0:e.asMutable)?e.asMutable({deep:!0}):e}function v(e){if(null==e||""===e)return null;if("number"==typeof e&&Number.isFinite(e))return e;if(e instanceof Date)return Number.isNaN(e.getTime())?null:e.getTime();const t=String(e),i=Date.parse(t);return Number.isNaN(i)?null:i}function m(e){if(null==e||""===e)return"";let t=null;if("number"==typeof e)t=new Date(e);else if("string"==typeof e){const i=Date.parse(e);Number.isNaN(i)||(t=new Date(i))}else e instanceof Date&&(t=e);return!t||Number.isNaN(t.getTime())?p(e):new Intl.DateTimeFormat("it-IT",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}).format(t)}function b(e){var t,i,r;try{null===(t=e.selectRecordsByIds)||void 0===t||t.call(e,[])}catch(e){}try{null===(i=e.clearSelection)||void 0===i||i.call(e)}catch(e){}try{null===(r=e.setSelectedRecords)||void 0===r||r.call(e,[])}catch(e){}}function h(e,t){const i=null==e||""===e,r=null==t||""===t;if(i&&r)return 0;if(i)return 1;if(r)return-1;if("number"==typeof e&&"number"==typeof t)return e-t;const a=String(e),o=String(t),n=Date.parse(a),l=Date.parse(o);return Number.isNaN(n)||Number.isNaN(l)?a.localeCompare(o,"it",{numeric:!0,sensitivity:"base"}):n-l}function x(e){return(e||[]).map(e=>`${e.field}:${e.dir}`).join("|")}function S(e){var i,r,a,o,n,l,s,d,c,u;const f=null!==(a=null===(r=null===(i=e.ds)||void 0===i?void 0:i.getRecords)||void 0===r?void 0:r.call(i))&&void 0!==a?a:[],p=null!==(d=null!==(n=null===(o=e.info)||void 0===o?void 0:o.status)&&void 0!==n?n:null===(s=null===(l=e.ds)||void 0===l?void 0:l.getStatus)||void 0===s?void 0:s.call(l))&&void 0!==d?d:t.DataSourceStatus.NotReady,g=p===t.DataSourceStatus.Loading;let v="";if(f.length>0)try{v=JSON.stringify((null===(u=(c=f[0]).getData)||void 0===u?void 0:u.call(c))||{})}catch(e){v=String(f.length)}const m=`${p}:${f.length}:${v}`,b=t.React.useRef("");return t.React.useEffect(()=>{m!==b.current&&(b.current=m,e.onUpdate(e.dsId,f,e.ds,g))},[m]),null}const y="https://services2.arcgis.com/vH5RykSdaAwiEGOJ/arcgis/rest/services/GII_uteniti/FeatureServer/0",D="https://cbsm-hub.maps.arcgis.com",_={1:"TR",2:"TI",3:"RZ",4:"RI",5:"DT",6:"DA"},w={6:100,5:90,4:80,3:70,2:60,1:10};function N(){return l(this,void 0,void 0,function*(){var e,t,i,r,a,o;try{const n=(yield s("esri/identity/IdentityManager")).credentials,l=null!==(t=null===(e=null==n?void 0:n.find)||void 0===e?void 0:e.call(n,e=>{var t;return null===(t=null==e?void 0:e.server)||void 0===t?void 0:t.includes("cbsm-hub")}))&&void 0!==t?t:null==n?void 0:n[0],d=null!==(i=null==l?void 0:l.token)&&void 0!==i?i:"",c=null!==(a=null!==(r=null==l?void 0:l.userId)&&void 0!==r?r:null==l?void 0:l.username)&&void 0!==a?a:"";if(!c||!d)return{username:"",isAdmin:!1};const u=yield fetch(`${D}/sharing/rest/community/self?f=json&token=${encodeURIComponent(d)}`),f=yield u.json(),p="org_admin"===(null==f?void 0:f.role)||(null===(o=null==f?void 0:f.privileges)||void 0===o?void 0:o.includes("portal:admin:viewUsers"))||!1;return{username:String((null==f?void 0:f.username)||c),isAdmin:p}}catch(e){return{username:"",isAdmin:!1}}})}function C(e){return 0===e||1===e||3===e?0:2===e?1:4===e?2:5===e?3:4}function j(o){var n,j,R,I,A,T;const P=null!==(n=o.config)&&void 0!==n?n:a,B=g(null!==(j=o.useDataSources)&&void 0!==j?j:(0,t.Immutable)([])),[z,k]=t.React.useState(null),[$,F]=t.React.useState(!0),[E,M]=t.React.useState(!1),[O,L]=t.React.useState(""),W=t.React.useCallback(()=>l(this,void 0,void 0,function*(){M(!1),L(""),F(!0);try{const e=yield s("esri/identity/IdentityManager");yield e.getCredential(`${D}/sharing/rest`,{prompt:!0});const{username:t,isAdmin:i}=yield N();if(!t)return M(!0),L("Accesso non riuscito. Riprova."),void F(!1);yield V(t,i)}catch(e){console.warn("\u{1f512} Login annullato o fallito:",e),M(!0),L("\xc8 necessario effettuare il login per accedere al gestionale."),F(!1)}}),[]),V=t.React.useCallback((e,t)=>l(this,void 0,void 0,function*(){if(t){const t={username:e,ruolo:null,ruoloLabel:"ADMIN",area:null,settore:null,ufficio:null,gruppo:"",isAdmin:!0};k(t);try{window.__giiUserRole=t}catch(e){}return F(!1),void M(!1)}yield function(){return l(this,void 0,void 0,function*(){var e;try{const t=(yield s("esri/identity/IdentityManager")).credentials;if(null==t?void 0:t.length){const i=null!==(e=t.find(e=>{var t;return null===(t=null==e?void 0:e.server)||void 0===t?void 0:t.includes("cbsm-hub")}))&&void 0!==e?e:t[0];if(null==i?void 0:i.token)return i.token}}catch(e){}return""})}();const i=yield function(e){return l(this,void 0,void 0,function*(){var t,i,r,a,o,n,l,d,c;if(!e)return null;try{const u=new(yield s("esri/layers/FeatureLayer"))({url:y});yield u.load().catch(()=>{});const f=yield u.queryFeatures({where:`username = '${e.replace(/'/g,"''")}'`,outFields:["username","ruolo","area","settore","ufficio","gruppo"],returnGeometry:!1}),p=null!==(t=null==f?void 0:f.features)&&void 0!==t?t:[];if(!p.length)return null;let g=p[0];for(const e of p){const t=Number(null!==(r=null===(i=g.attributes)||void 0===i?void 0:i.ruolo)&&void 0!==r?r:0),s=Number(null!==(o=null===(a=e.attributes)||void 0===a?void 0:a.ruolo)&&void 0!==o?o:0);(null!==(n=w[s])&&void 0!==n?n:0)>(null!==(l=w[t])&&void 0!==l?l:0)&&(g=e)}const v=g.attributes,m=null!=v.ruolo?Number(v.ruolo):null;return{username:e,ruolo:m,ruoloLabel:m&&null!==(d=_[m])&&void 0!==d?d:"",area:null!=v.area?Number(v.area):null,settore:null!=v.settore?Number(v.settore):null,ufficio:null!=v.ufficio?Number(v.ufficio):null,gruppo:String(null!==(c=v.gruppo)&&void 0!==c?c:""),isAdmin:!1}}catch(e){return null}})}(e),r=i?Object.assign(Object.assign({},i),{isAdmin:!1}):{username:e,ruolo:null,ruoloLabel:"",area:null,settore:null,ufficio:null,gruppo:"",isAdmin:!1};k(r);try{window.__giiUserRole=r}catch(e){}F(!1),M(!1)}),[]);t.React.useEffect(()=>{let e=!1,t=null;return(()=>{l(this,void 0,void 0,function*(){F(!0);try{const{username:t,isAdmin:i}=yield N();if(e)return;if(t)yield V(t,i);else{const t=yield s("esri/identity/IdentityManager");try{if(yield t.getCredential(`${D}/sharing/rest`,{prompt:!0}),e)return;const{username:i,isAdmin:r}=yield N();if(!i)return void(e||(M(!0),F(!1)));yield V(i,r)}catch(t){e||(M(!0),L("Login necessario per accedere al gestionale."),F(!1))}}}catch(t){e||(M(!0),F(!1))}try{const i=yield s("esri/identity/IdentityManager");if(e)return;t=i.on("credential-create",()=>l(this,void 0,void 0,function*(){if(e)return;console.log("\u{1f510} Credential change detected, reloading user...");const{username:t,isAdmin:i}=yield N();t&&(yield V(t,i))}))}catch(e){}})})(),()=>{e=!0;try{null==t||t.remove()}catch(e){}}},[]),t.React.useEffect(()=>{if(z)try{window.__giiUserRole=z}catch(e){}},[z]);const U=t.React.useMemo(()=>z?function(e){if(!e)return null;if(e.isAdmin)return null;const{ruolo:t,area:i,settore:r}=e;if(null!==t&&t>=1&&t<=3){if(2===i){if(3===r)return["dataSource_39"];if(4===r)return["dataSource_38"];if(5===r)return["dataSource_37"];if(6===r)return["dataSource_36"];if(7===r)return["dataSource_35"];if(8===r)return["dataSource_34"]}if(3===i)return["dataSource_33"]}if(null!==t&&t>=4&&t<=6){if(2===i)return["dataSource_41"];if(3===i)return["dataSource_40"];if(1===i)return["dataSource_32"]}return[]}(z):null,[null==z?void 0:z.username,null==z?void 0:z.ruolo,null==z?void 0:z.area,null==z?void 0:z.settore,null==z?void 0:z.isAdmin]),H=t.React.useMemo(()=>!z||$||E?[]:null===U?B:B.filter(e=>U.includes(String((null==e?void 0:e.dataSourceId)||""))),[z,$,E,U,B.length]),G=(null==z?void 0:z.isAdmin)?null:(null==z?void 0:z.ruoloLabel)?function(e){const t=e.toUpperCase();return"TR"===t?"stato_TR":"TI"===t?"stato_TI":"RZ"===t?"stato_RZ":"RI"===t?"stato_RI":"DT"===t?"stato_DT":"DA"===t?"stato_DA":"stato_DT"}(z.ruoloLabel):null,[q,J]=t.React.useState("tutte"),X=t.React.useCallback(e=>G&&"tutte"!==q?e.filter(e=>{var t;const i=((null===(t=e.getData)||void 0===t?void 0:t.call(e))||{})[G],r=null!=i?Number(i):null;return"attesa_mia"===q?0===r||1===r||3===r:"attesa_altri"!==q||(2===r||4===r)}):e,[G,q]),Y=t.React.useCallback(e=>G?[...e].sort((e,t)=>{var i,r;const a=(null===(i=e.getData)||void 0===i?void 0:i.call(e))||{},o=(null===(r=t.getData)||void 0===r?void 0:r.call(t))||{};return C(null!=a[G]?Number(a[G]):null)-C(null!=o[G]?Number(o[G]):null)}):e,[G]),Z=t.React.useMemo(()=>{const e=g(P.filterTabs)||[],i=[],r=new Map;return H.forEach((a,o)=>{const n=String((null==a?void 0:a.dataSourceId)||""),l=e.find(e=>String((null==e?void 0:e.dataSourceId)||"")===n),s=String((null==l?void 0:l.label)||function(e,i){var r;try{const a=t.DataSourceManager.getInstance().getDataSource(null==e?void 0:e.dataSourceId),o=null===(r=null==a?void 0:a.getLabel)||void 0===r?void 0:r.call(a);return o&&String(o).trim()?String(o):i}catch(e){return i}}(a,`Filtro ${o+1}`));r.has(s)?i[r.get(s)].dsIndices.push(o):(r.set(s,i.length),i.push({label:s,dsIndices:[o]}))}),i},[H.length,P.filterTabs]),K=Z.length>1,[Q,ee]=t.React.useState(0),[te,ie]=t.React.useState({}),re=t.React.useRef({}),[ae,oe]=t.React.useState(0),ne=t.React.useCallback((e,t,i,r)=>{re.current[e]={recs:t,ds:i,loading:r},oe(e=>e+1)},[]);t.React.useEffect(()=>{const e=[500,1500,3e3].map(e=>setTimeout(()=>{let e=!1;Object.entries(re.current).forEach(([t,i])=>{var r,a,o;if(i.ds){const n=null!==(o=null===(a=(r=i.ds).getRecords)||void 0===a?void 0:a.call(r))&&void 0!==o?o:[];n.length>0&&(re.current[t]=Object.assign(Object.assign({},i),{recs:n,loading:!1}),e=!0)}}),e&&oe(e=>e+1)},e));return()=>e.forEach(e=>clearTimeout(e))},[B.length]);const le=t.React.useMemo(()=>[{field:p(P.orderByField||"objectid"),dir:"ASC"===p(P.orderByDir||"DESC").toUpperCase()?"ASC":"DESC"}],[P.orderByField,P.orderByDir]),[se,de]=t.React.useState(le);t.React.useEffect(()=>{x(se)!==x(le)||de(le)},[x(le)]);const ce=Math.min(Q,Math.max(0,Z.length-1)),ue=Z[ce]||Z[0],fe=(o.useDataSources,p(P.whereClause||"1=1")),pe=f(P.pageSize,200),ge=t.React.useMemo(()=>({where:fe,pageSize:pe}),[fe,pe]),ve=p(P.fieldPratica||"objectid"),me=p(P.fieldDataRilevazione||"data_rilevazione"),be=p(P.fieldUfficio||"ufficio_zona"),he=p(P.fieldPresaDT||"presa_in_carico_DT"),xe=p(P.fieldDtPresaDT||"dt_presa_in_carico_DT"),Se=p(P.fieldStatoDT||"stato_DT"),ye=p(P.fieldDtStatoDT||"dt_stato_DT"),De=p(P.fieldEsitoDT||"esito_DT"),_e=p(P.fieldDtEsitoDT||"dt_esito_DT"),we=p(P.fieldPresaDA||"presa_in_carico_DA"),Ne=p(P.fieldDtPresaDA||"dt_presa_in_carico_DA"),Ce=p(P.fieldStatoDA||"stato_DA"),je=p(P.fieldDtStatoDA||"dt_stato_DA"),Re=p(P.fieldEsitoDA||"esito_DA"),Ie=p(P.fieldDtEsitoDA||"dt_esito_DA"),Ae=f(P.presaDaPrendereVal,1),Te=f(P.presaPresaVal,2),Pe=f(P.statoDaPrendereVal,1),Be=f(P.statoPresaVal,2),ze=f(P.statoIntegrazioneVal,3),ke=f(P.statoApprovataVal,4),$e=f(P.statoRespintaVal,5),Fe=f(P.esitoIntegrazioneVal,1),Ee=f(P.esitoApprovataVal,2),Me=f(P.esitoRespintaVal,3),Oe=e=>{const t=Number(e);return Number.isFinite(t)?t===Pe?p(P.labelStatoDaPrendere||"Da prendere"):t===Be?p(P.labelStatoPresa||"Presa in carico"):t===ze?p(P.labelStatoIntegrazione||"Integrazione richiesta"):t===ke?p(P.labelStatoApprovata||"Approvata"):t===$e?p(P.labelStatoRespinta||"Respinta"):String(t):p(e)},Le=e=>{const t=Number(e);return Number.isFinite(t)?t===Fe?p(P.labelEsitoIntegrazione||"Integrazione richiesta"):t===Ee?p(P.labelEsitoApprovata||"Approvata"):t===Me?p(P.labelEsitoRespinta||"Respinta"):String(t):p(e)},We=e=>{const t=null!==e[we]&&void 0!==e[we]&&""!==e[we]||null!==e[Ce]&&void 0!==e[Ce]&&""!==e[Ce]||null!==e[Re]&&void 0!==e[Re]&&""!==e[Re],i=t?"DA":"DT",r=Number(t?e[Ce]:e[Se]),a=Number(t?e[Re]:e[De]);if(Number.isFinite(a))return{ruolo:i,label:Le(a),statoForChip:Ve(a)};if(Number.isFinite(r))return{ruolo:i,label:Oe(r),statoForChip:r};const o=Number(t?e[we]:e[he]);return Number.isFinite(o)?o===Ae?{ruolo:i,label:p(P.labelPresaDaPrendere||"Da prendere in carico"),statoForChip:Pe}:o===Te?{ruolo:i,label:p(P.labelPresaPresa||"Presa in carico"),statoForChip:Be}:{ruolo:i,label:String(o),statoForChip:null}:{ruolo:i,label:"\u2014",statoForChip:null}},Ve=e=>e===Fe?ze:e===Ee?ke:e===Me?$e:ke,Ue=e=>{const t=[v(e[xe]),v(e[ye]),v(e[_e]),v(e[Ne]),v(e[je]),v(e[Ie])].filter(e=>null!==e);return t&&0!==t.length?Math.max(...t):null},He=(e,t)=>{const i=Number("DA"===t?e[we]:e[he]),r=Number("DA"===t?e[Ce]:e[Se]),a=Number("DA"===t?e[Re]:e[De]),o=t;return Number.isFinite(i)&&i===Ae?`Prendere in carico (${o})`:Number.isFinite(r)&&r===ze||Number.isFinite(a)&&a===Fe?`Gestire integrazione (${o})`:Number.isFinite(r)&&r===$e||Number.isFinite(a)&&a===Me?`Verificare respinta (${o})`:Number.isFinite(r)&&r===ke||Number.isFinite(a)&&a===Ee?`Approvata (${o})`:Number.isFinite(r)&&r===Be||Number.isFinite(i)&&i===Te?`Valutare esito (${o})`:`Verificare stato (${o})`},Ge=(e,t)=>{var i;const r=(null===(i=e.getData)||void 0===i?void 0:i.call(e))||{};if(t===d){return We(r).label}if(t===c)return Ue(r);if(t===u){const e=We(r);return He(r,e.ruolo)}return r[t]},qe=x(se)!==x(le),Je=t.React.useMemo(()=>{var e;if(!ue)return[];const t=[];for(const i of ue.dsIndices){const r=String((null===(e=H[i])||void 0===e?void 0:e.dataSourceId)||""),a=re.current[r];(null==a?void 0:a.recs)&&t.push(...a.recs)}const i=X(t);return((e,t)=>{if(!t||0===t.length)return e;const i=[...e];return i.sort((e,i)=>{for(const r of t){const t=h(Ge(e,r.field),Ge(i,r.field));if(0!==t)return"ASC"===r.dir?t:-t}return 0}),i})(Y(i),se)},[ue,ae,se,q,G]),Xe=t.React.useMemo(()=>{var e;const t=new WeakMap;if(!ue)return t;for(const i of ue.dsIndices){const r=String((null===(e=H[i])||void 0===e?void 0:e.dataSourceId)||""),a=re.current[r];if(null==a?void 0:a.recs)for(const e of a.recs)t.set(e,r)}return t},[ue,ae]),Ye=null!==(R=null==ue?void 0:ue.dsIndices.every(e=>{var t;const i=String((null===(t=H[e])||void 0===t?void 0:t.dataSourceId)||""),r=re.current[i];return!r||r.loading}))&&void 0!==R&&R,Ze=f(P.gap,12),Ke=f(P.paddingLeftFirstCol,0),Qe=function(e){const t=g(null==e?void 0:e.columns);return Array.isArray(t)&&t.length>0?t.map(e=>({id:String(e.id||""),label:String(e.label||""),field:String(e.field||""),width:f(e.width,150)})):r.map(e=>Object.assign({},e))}(g(P)),et=Qe.map(e=>`${e.width}px`).join(" "),tt=Qe.reduce((e,t)=>e+t.width,0)+Ze*Math.max(0,Qe.length-1)+24,it=f(P.rowGap,8),rt=f(P.rowPaddingX,12),at=f(P.rowPaddingY,10),ot=f(P.rowMinHeight,44),nt=f(P.rowRadius,12),lt=f(P.rowBorderWidth,1),st=p(P.rowBorderColor||"rgba(0,0,0,0.08)"),dt=f(P.statoChipRadius,999),ct=f(P.statoChipPadX,10),ut=f(P.statoChipPadY,4),ft=f(P.statoChipBorderW,1),pt=f(P.statoChipFontWeight,600),gt=f(P.statoChipFontSize,12),vt="italic"===P.statoChipFontStyle?"italic":"normal",mt=["none","uppercase","lowercase","capitalize"].includes(P.statoChipTextTransform)?P.statoChipTextTransform:"none",bt=f(P.statoChipLetterSpacing,0),ht=t.css`
    height: 100%;
    width: 100%;
    display: flex;
    flex-direction: column;

    .tabBar {
      display: ${K?"flex":"none"};
      gap: 8px;
      padding: 8px 12px;
      border-bottom: 1px solid rgba(0,0,0,0.08);
      background: var(--bs-body-bg, #fff);
    }
    .tabBtn {
      border: 1px solid rgba(0,0,0,0.12);
      background: rgba(0,0,0,0.02);
      color: #111827;
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
      white-space: nowrap;
    }
    .tabBtn.active {
      background: #eaf2ff;
      border-color: #2f6fed;
      color: #1d4ed8;
    }

    .viewport { flex: 1; min-height: 0; overflow: auto; }
    .content { min-width: ${tt}px; padding: 0 12px 10px; }

    .headerWrap {
      position: sticky;
      top: 0;
      z-index: 2;
      background: var(--bs-body-bg, #fff);
      border-bottom: 1px solid rgba(0,0,0,0.08);
      padding: 6px 12px;
      margin: 0 0 8px 0;
    }

    .gridHeader {
      display: grid;
      grid-template-columns: ${et};
      column-gap: ${Ze}px;
      align-items: center;
      min-height: 28px;
    }

    .headerCell {
      display: flex;
      align-items: center;
      min-width: 0;
      font-weight: 700;
      font-size: 12px;
      color: rgba(0,0,0,0.65);
    }

    .hdrBtn {
      width: 100%;
      border: none;
      background: transparent;
      padding: 0;
      margin: 0;
      text-align: left;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: inherit;
      font: inherit;
      line-height: 1;
    }
    .hdrBtn:hover { color: rgba(0,0,0,0.9); }

    .sortBadge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      opacity: 0.85;
    }
    .sortPri {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      border-radius: 4px;
      background: rgba(0,0,0,0.07);
      font-weight: 800;
    }

    .resetBtn {
      padding: 0 10px !important;
      height: 28px !important;
      min-height: 28px !important;
      line-height: 1 !important;
      white-space: nowrap !important;
      font-size: 12px !important;
      font-weight: 700 !important;
    }

    .first { padding-left: ${Ke}px; }

    .list { display: flex; flex-direction: column; }

    .rowCard {
      display: grid;
      grid-template-columns: ${et};
      column-gap: ${Ze}px;
      align-items: center;

      padding: ${at}px ${rt}px;
      min-height: ${ot}px;

      border-radius: ${nt}px;
      border: ${lt}px solid ${st};

      margin-bottom: ${it}px;
      cursor: pointer;
    }
    .rowCard.even { background: ${p(P.zebraEvenBg||"#ffffff")}; }
    .rowCard.odd  { background: ${p(P.zebraOddBg||"#fbfbfb")}; }
    .rowCard:hover { background: ${p(P.hoverBg||"#f2f6ff")}; }

    .rowCard.selected {
      border-color: ${p(P.selectedBorderColor||"#2f6fed")};
      box-shadow: 0 0 0 ${f(P.selectedBorderWidth,2)}px rgba(47,111,237,0.18);
      background: ${p(P.selectedBg||"#eaf2ff")};
    }

    .cell {
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      padding: ${ut}px ${ct}px;
      border-radius: ${dt}px;
      border: ${ft}px solid rgba(0,0,0,0.12);
      font-weight: ${pt};
      font-size: ${gt}px;
      font-style: ${vt};
      text-transform: ${mt};
      letter-spacing: ${bt}px;
      line-height: 1;
      white-space: nowrap;
      max-width: 100%;
    }

    .empty { padding: 14px; color: rgba(0,0,0,0.65); }
  `,xt=t=>{const i=se.findIndex(e=>e.field===t.field),r=i>=0?se[i]:null,a=null==r?void 0:r.dir,o=r?(0,e.jsxs)("span",{className:"sortBadge","aria-hidden":!0,children:[(0,e.jsx)("span",{className:"sortPri",children:i+1}),(0,e.jsx)("span",{children:"ASC"===a?"\u2191":"\u2193"})]}):(0,e.jsx)("span",{className:"sortBadge",style:{opacity:.35},"aria-hidden":!0,children:"\u2195"});return(0,e.jsx)("div",{className:"headerCell "+(t.first?"first":""),children:(0,e.jsxs)("button",{type:"button",className:"hdrBtn",onClick:e=>{return i=t.field,r=!0===e.shiftKey,void de(e=>{const t=[...e],a=t.findIndex(e=>e.field===i);if(a>=0){const e="ASC"===t[a].dir?"DESC":"ASC";return t[a]={field:i,dir:e},r?t:[t[a]]}const o={field:i,dir:"ASC"};return r?[...t,o]:[o]});var i,r},title:"Click: ordina. Shift+Click: ordinamento multiplo.",children:[(0,e.jsx)("span",{children:t.label}),o]})})},St=Number.isFinite(Number(P.maskOuterOffset))?Number(P.maskOuterOffset):12,yt=Number.isFinite(Number(P.maskInnerPadding))?Number(P.maskInnerPadding):8,Dt=String(null!==(I=P.maskBg)&&void 0!==I?I:"#ffffff"),_t=String(null!==(A=P.maskBorderColor)&&void 0!==A?A:"rgba(0,0,0,0.12)"),wt=Number.isFinite(Number(P.maskBorderWidth))?Number(P.maskBorderWidth):1,Nt=Number.isFinite(Number(P.maskRadius))?Number(P.maskRadius):12;if(!B.length)return(0,e.jsx)("div",{style:{padding:12},children:p(P.errorNoDs||"Configura la fonte dati del widget.")});const Ct=p(P.listTitleText||"Elenco rapporti di rilevazione"),jt=f(P.listTitleHeight,28),Rt=f(P.listTitlePaddingBottom,10),It=f(P.listTitlePaddingLeft,0),At=f(P.listTitleFontSize,14),Tt=f(P.listTitleFontWeight,600),Pt=p(P.listTitleColor||"rgba(0,0,0,0.85)");return(0,e.jsxs)("div",{style:{width:"100%",height:"100%",boxSizing:"border-box",padding:St,display:"flex",flexDirection:"column",minHeight:0},children:[Ct&&(0,e.jsx)("div",{style:{height:jt,paddingBottom:Rt,paddingLeft:It,display:"flex",alignItems:"center",boxSizing:"border-box",flex:"0 0 auto"},children:(0,e.jsx)("span",{style:{fontSize:At,fontWeight:Tt,color:Pt},children:Ct})}),(0,e.jsx)("div",{style:{width:"100%",flex:"1 1 auto",minHeight:0,boxSizing:"border-box",border:`${wt}px solid ${_t}`,borderRadius:Nt,background:Dt,padding:yt,overflow:"hidden"},children:(0,e.jsxs)("div",{css:ht,style:{width:"100%",height:"100%"},children:[(E||$&&!z)&&(0,e.jsx)("div",{style:{position:"absolute",inset:0,zIndex:100,background:"rgba(255,255,255,0.97)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:16,padding:32,textAlign:"center",borderRadius:Nt},children:$&&!E?(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)(i.Loading,{}),(0,e.jsx)("div",{style:{fontSize:14,color:"#374151"},children:"Accesso in corso\u2026"})]}):(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{style:{fontSize:32},children:"\u{1f512}"}),(0,e.jsx)("div",{style:{fontSize:16,fontWeight:700,color:"#111827"},children:"Accesso richiesto"}),(0,e.jsx)("div",{style:{fontSize:13,color:"#6b7280",maxWidth:320},children:O||"Devi effettuare il login con le credenziali CBSM per accedere al gestionale infrazioni."}),(0,e.jsx)("button",{type:"button",onClick:W,style:{marginTop:8,padding:"10px 28px",background:"#2f6fed",color:"#fff",border:"none",borderRadius:8,fontSize:14,fontWeight:700,cursor:"pointer"},children:"Accedi"})]})}),!$&&!E&&(null==z?void 0:z.username)&&H.map((i,r)=>{var a;return(0,e.jsx)(t.DataSourceComponent,{useDataSource:null===(a=o.useDataSources)||void 0===a?void 0:a[B.findIndex(e=>(null==e?void 0:e.dataSourceId)===(null==i?void 0:i.dataSourceId))],query:ge,widgetId:o.id,children:(t,r)=>(0,e.jsx)(S,{ds:t,dsId:String((null==i?void 0:i.dataSourceId)||""),info:r,onUpdate:ne})},(null==i?void 0:i.dataSourceId)||r)}),!$&&G&&(0,e.jsxs)("div",{style:{display:"flex",gap:8,padding:"8px 12px",borderBottom:"1px solid rgba(0,0,0,0.08)",alignItems:"center",flexWrap:"wrap"},children:[(0,e.jsx)("span",{style:{fontSize:11,color:"#6b7280",marginRight:4},children:(null==z?void 0:z.isAdmin)?"\u{1f464} Admin":`\u{1f464} ${null!==(T=null==z?void 0:z.ruoloLabel)&&void 0!==T?T:""}`}),[{id:"tutte",label:"Tutte le pratiche"},{id:"attesa_mia",label:"In attesa mia"},{id:"attesa_altri",label:"In attesa altri"}].map(t=>(0,e.jsxs)("button",{type:"button",className:"tabBtn "+(q===t.id?"active":""),onClick:()=>J(t.id),children:[t.label,(()=>{var i;if(!ue)return null;const r=[];for(const e of ue.dsIndices){const t=String((null===(i=H[e])||void 0===i?void 0:i.dataSourceId)||""),a=re.current[t];(null==a?void 0:a.recs)&&r.push(...a.recs)}const a="tutte"===t.id?r.length:r.filter(e=>{var i;const r=(null===(i=e.getData)||void 0===i?void 0:i.call(e))||{},a=null!=r[G]?Number(r[G]):null;return"attesa_mia"===t.id?0===a||1===a||3===a:"attesa_altri"===t.id&&(2===a||4===a)}).length;return a>0?(0,e.jsx)("span",{style:{marginLeft:6,background:q===t.id?"#2f6fed":"rgba(0,0,0,0.1)",color:q===t.id?"#fff":"#374151",borderRadius:999,padding:"1px 7px",fontSize:11,fontWeight:700},children:a}):null})()]},t.id))]}),!$&&(null==z?void 0:z.isAdmin)&&(0,e.jsx)("div",{style:{padding:"6px 12px",fontSize:11,color:"#6b7280",borderBottom:"1px solid rgba(0,0,0,0.06)",background:"#fafafa"},children:"\u{1f464} Admin \u2014 visualizzazione completa senza filtri ruolo"}),$&&(0,e.jsx)("div",{style:{padding:"6px 12px",fontSize:11,color:"#6b7280"},children:"Rilevamento ruolo utente\u2026"}),K&&!G&&(0,e.jsx)("div",{className:"tabBar",children:Z.map((t,i)=>(0,e.jsx)("button",{type:"button",className:"tabBtn "+(i===Q?"active":""),onClick:()=>{const e=Z[Q];e&&(e.dsIndices.forEach(e=>{var t;const i=String((null===(t=H[e])||void 0===t?void 0:t.dataSourceId)||""),r=re.current[i];(null==r?void 0:r.ds)&&b(r.ds)}),ie(t=>{const i=Object.assign({},t);return e.dsIndices.forEach(e=>{var t;delete i[String((null===(t=H[e])||void 0===t?void 0:t.dataSourceId)||"")]}),i})),ee(i)},title:t.label,children:t.label},t.label))}),(0,e.jsx)("div",{className:"viewport",children:(0,e.jsxs)("div",{className:"content",children:[Ye&&(0,e.jsx)(i.Loading,{}),!Ye&&0===Je.length&&(0,e.jsx)("div",{className:"empty",children:p(P.emptyMessage||"Nessun record trovato.")}),Je.length>0&&(0,e.jsxs)(e.Fragment,{children:[!1!==P.showHeader&&(0,e.jsxs)("div",{className:"headerWrap",children:[(0,e.jsx)("div",{style:{display:"flex",justifyContent:"flex-end",marginBottom:6},children:qe&&(0,e.jsx)(i.Button,{size:"sm",type:"tertiary",className:"resetBtn",onClick:()=>de(le),title:"Ripristina ordinamento di default","aria-label":"Reset ordinamento",children:"Reset"})}),(0,e.jsx)("div",{className:"gridHeader",children:Qe.map((t,i)=>(0,e.jsx)(xt,{first:0===i,label:t.label,field:t.field},t.id))})]}),(0,e.jsx)("div",{className:"list",children:Je.map((i,r)=>{var a,o,n;const l=(null===(a=i.getData)||void 0===a?void 0:a.call(i))||{},s=Number(l.OBJECTID),f=String(null!==(n=null===(o=i.getId)||void 0===o?void 0:o.call(i))&&void 0!==n?n:s),g=Xe.get(i)||"",v=String(ve||"").toLowerCase(),h="objectid"===v||"oid"===v||"object_id"===v?function(e){var t,i,r,a,o;const n=(null===(t=null==e?void 0:e.getData)||void 0===t?void 0:t.call(e))||{},l=null!==(a=null!==(r=null!==(i=null==n?void 0:n.OBJECTID)&&void 0!==i?i:null==n?void 0:n.ObjectId)&&void 0!==r?r:null==n?void 0:n.objectid)&&void 0!==a?a:null==n?void 0:n.objectId;let s="TR";const d=null==n?void 0:n.origine_pratica;if(2===d||"2"===d)s="TI";else if(1===d||"1"===d)s="TR";else{const t=String((null===(o=null==e?void 0:e.dataSource)||void 0===o?void 0:o.id)||"").toLowerCase();(t.includes("gii_pratiche")||t.includes("schema")||t.includes("ti"))&&(s="TI")}return null!=l?`${s}-${l}`:`${s}-?`}(i):p(l[ve]),x=(m(l[me]),p(l[be]),We(l)),S=p(x.label),y=x.statoForChip,D=Ue(l),_=D?m(D):"\u2014",w=He(l,x.ruolo),N=te[g]===f,C=r%2==0;return(0,e.jsx)("div",{className:`rowCard ${C?"even":"odd"} ${N?"selected":""}`,onClick:()=>{if(N)ie({}),Object.keys(re.current).forEach(e=>{const t=re.current[e];(null==t?void 0:t.ds)&&b(t.ds)}),H.forEach(e=>{var i,r,a;const o=String((null==e?void 0:e.dataSourceId)||"");try{const e=t.DataSourceManager.getInstance().getDataSource(o);e&&b(e);const n=(null===(i=null==e?void 0:e.parentDataSource)||void 0===i?void 0:i.id)||(null===(a=null===(r=null==e?void 0:e.getMainDataSource)||void 0===r?void 0:r.call(e))||void 0===a?void 0:a.id);if(n){const e=t.DataSourceManager.getInstance().getDataSource(n);e&&b(e)}}catch(e){}});else{Object.keys(re.current).forEach(e=>{const t=re.current[e];(null==t?void 0:t.ds)&&b(t.ds)}),ie({[g]:f});const e=re.current[g];(null==e?void 0:e.ds)&&function(e,t,i){var r,a,o;try{null===(r=e.selectRecordsByIds)||void 0===r||r.call(e,[i])}catch(e){}try{null===(a=e.selectRecordById)||void 0===a||a.call(e,i)}catch(e){}try{null===(o=e.setSelectedRecords)||void 0===o||o.call(e,[t])}catch(e){}}(e.ds,i,f),ue&&ue.dsIndices.forEach(e=>{var r,a,o,n,l,s,d;const c=String((null===(r=H[e])||void 0===r?void 0:r.dataSourceId)||"");if(c===g)return;const u=re.current[c];if(null==u?void 0:u.ds){try{null===(o=(a=u.ds).setSelectedRecords)||void 0===o||o.call(a,[i])}catch(e){}try{null===(l=(n=u.ds).selectRecordsByIds)||void 0===l||l.call(n,[f])}catch(e){}}try{const e=t.DataSourceManager.getInstance().getDataSource(c),r=(null==e?void 0:e.parentDataSource)||(null===(s=null==e?void 0:e.getMainDataSource)||void 0===s?void 0:s.call(e));if(r)try{null===(d=r.setSelectedRecords)||void 0===d||d.call(r,[i])}catch(e){}}catch(e){}})}},children:Qe.map((t,i)=>{const r=t.field;if(r===d)return(0,e.jsx)("div",{className:0===i?"cell first":"cell",title:S,children:(0,e.jsx)("span",{className:"chip",style:(a=Number.isFinite(Number(y))?Number(y):null,a===Pe?{background:p(P.statoBgDaPrendere||"#fff7e6"),color:p(P.statoTextDaPrendere||"#7a4b00"),borderColor:p(P.statoBorderDaPrendere||"#ffd18a")}:a===Be?{background:p(P.statoBgPresa||"#eaf7ef"),color:p(P.statoTextPresa||"#1f6b3a"),borderColor:p(P.statoBorderPresa||"#9ad2ae")}:{background:p(P.statoBgAltro||"#f2f2f2"),color:p(P.statoTextAltro||"#333333"),borderColor:p(P.statoBorderAltro||"#d0d0d0")}),children:S})},t.id);var a;if(r===c)return(0,e.jsx)("div",{className:0===i?"cell first":"cell",title:_,children:_},t.id);if(r===u)return(0,e.jsx)("div",{className:0===i?"cell first":"cell",title:w,children:w},t.id);const o=r.toLowerCase();if("objectid"===o||"oid"===o||"object_id"===o)return(0,e.jsx)("div",{className:0===i?"cell first":"cell",title:h,children:h},t.id);if(o.startsWith("data_")||o.startsWith("dt_")){const a=m(l[r]);return(0,e.jsx)("div",{className:0===i?"cell first":"cell",title:a,children:a},t.id)}const n=p(l[r]);return(0,e.jsx)("div",{className:0===i?"cell first":"cell",title:n,children:n},t.id)})},`${g}_${f}`)})})]})]})})]})})]})}function R(e){o.p=e}})(),n})())}}});