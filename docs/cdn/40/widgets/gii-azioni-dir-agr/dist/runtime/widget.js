System.register(["jimu-core/emotion","jimu-core","jimu-ui","jimu-core/react-dom"],function(e,t){var i={},n={},l={},o={};return{setters:[function(e){i.Fragment=e.Fragment,i.jsx=e.jsx,i.jsxs=e.jsxs},function(e){n.DataSourceComponent=e.DataSourceComponent,n.DataSourceManager=e.DataSourceManager,n.Immutable=e.Immutable,n.React=e.React},function(e){l.Button=e.Button},function(e){o.createPortal=e.createPortal}],execute:function(){e((()=>{var e={244:e=>{"use strict";e.exports=n},321:e=>{"use strict";e.exports=l},386:e=>{"use strict";e.exports=i},581:e=>{"use strict";e.exports=o}},t={};function r(i){var n=t[i];if(void 0!==n)return n.exports;var l=t[i]={exports:{}};return e[i](l,l.exports,r),l.exports}r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="";var a={};return r.p=window.jimuConfig.baseUrl,(()=>{"use strict";r.r(a),r.d(a,{__set_webpack_public_path__:()=>q,default:()=>H});var e=r(386),t=r(244),i=r(321),n=r(581);const l={roleCode:"DT",buttonText:"Prendi in carico",takeColor:"#0078da",integrazioneColor:"#e75a05",approvaColor:"#328c54",respingiColor:"#d13438",trasmettiColor:"#6f42c1",panelBg:"#ffffff",panelBorderColor:"#e5e7eb",panelBorderWidth:1,panelBorderRadius:10,panelPadding:12,maskBg:"#ffffff",maskBorderColor:"#e5e7eb",maskBorderWidth:1,maskBorderRadius:10,maskInnerPadding:12,maskOuterOffset:12,dividerColor:"#e5e7eb",titleFontSize:14,statusFontSize:13,msgFontSize:15,detailTitlePrefix:"Dettaglio rapporto n.",detailTitleHeight:28,detailTitlePaddingBottom:10,detailTitlePaddingLeft:0,detailTitleFontSize:14,detailTitleFontWeight:600,detailTitleColor:"rgba(0,0,0,0.85)",detailTitleBg:"transparent",btnBorderRadius:8,btnFontSize:14,btnFontWeight:600,btnPaddingX:14,btnPaddingY:10,rejectReasons:["Mancanza requisiti","Documentazione incompleta","Dati incoerenti","Richiesta non ammissibile","Altro"],reasonsZebraOddBg:"#ffffff",reasonsZebraEvenBg:"#f6f7f9",reasonsRowBorderColor:"rgba(0,0,0,0.10)",reasonsRowBorderWidth:1,reasonsRowRadius:8,tabs:[{id:"anagrafica",label:"Anagrafica",fields:[],hideEmpty:!1},{id:"violazione",label:"Violazione",fields:[],hideEmpty:!0},{id:"iter",label:"Iter",fields:[],isIterTab:!0,hideEmpty:!1},{id:"allegati",label:"Allegati",fields:[],hideEmpty:!0},{id:"azioni",label:"Azioni",fields:[],locked:!0}],showEditButtons:!0,editOverlayColor:"#7c3aed",editPageColor:"#5b21b6",editPageId:"editing-ti",fieldStatoTI:"stato_TI",fieldPresaTI:"presa_in_carico_TI",editMinStato:2,editMaxStato:2,editPresaRequiredVal:2,presets:[],activePresetId:""};(0,t.Immutable)(l);var o=function(e,t,i,n){return new(i||(i=Promise))(function(l,o){function r(e){try{d(n.next(e))}catch(e){o(e)}}function a(e){try{d(n.throw(e))}catch(e){o(e)}}function d(e){var t;e.done?l(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(r,a)}d((n=n.apply(e,t||[])).next())})},d=function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var l=0;for(n=Object.getOwnPropertySymbols(e);l<n.length;l++)t.indexOf(n[l])<0&&Object.prototype.propertyIsEnumerable.call(e,n[l])&&(i[n[l]]=e[n[l]])}return i};const s="https://services2.arcgis.com/vH5RykSdaAwiEGOJ/arcgis/rest/services/GII_LOG_MODIFICHE/FeatureServer/0";function u(e){return e&&(e.layer||e)||null}function c(e){return new Promise((t,i)=>{const n=window.require;if(n)try{n([e],e=>t(e),e=>i(e))}catch(e){i(e)}else i(new Error("AMD require non disponibile"))})}function g(e){return String(null!=e?e:"").trim().toLowerCase()}function f(e){return String(null!=e?e:"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^a-z0-9]+/g," ").trim().replace(/\s+/g," ")}function v(e){return null==e||("string"==typeof e?""===e.trim():!!Array.isArray(e)&&0===e.length)}function p(e,t){const i=f(e),n=f(t);if(!n)return!1;var l;return new RegExp(`(^| )${l=n,l.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}( |$)`).test(i)}function b(e,t){const i=g(t),n=g(e),l=i||n;return l?l.includes("fisica")||"pf"==l||l.startsWith("pf ")?"PF":l.includes("giurid")||"pg"==l||l.startsWith("pg ")?"PG":"1"==n?"PF":"2"==n?"PG":null:null}function y(e,t){const i=(null==t?void 0:t.fields)||[];if(!i.length)return e;const n=new Set(i.map(e=>String(e.name))),l={};for(const t of Object.keys(e))n.has(t)&&(l[t]=e[t]);return l}function m(e){return o(this,void 0,void 0,function*(){if(!e)return;let t=e;try{for(;t&&t.belongToDataSource;)t=t.belongToDataSource}catch(e){}const i=[];t&&i.push(t);try{const e=(null==t?void 0:t.getAllDerivedDataSources)?t.getAllDerivedDataSources():[];e&&e.length&&i.push(...e)}catch(e){}for(const e of i)try{const t=e.getCurrentQueryParams?e.getCurrentQueryParams():null;e.clearSourceRecords&&e.clearSourceRecords(),e.addVersion&&e.addVersion(),e.load&&(t?yield e.load(t):yield e.load())}catch(e){}})}function h(e,t){const i={fontSize:t,lineHeight:1.35,whiteSpace:"normal"};return"ok"===e?Object.assign(Object.assign({},i),{color:"#1a7f37"}):"err"===e?Object.assign(Object.assign({},i),{color:"#b42318"}):Object.assign(Object.assign({},i),{color:"#4b5563"})}function S(e,t){var i,n,l,o;return String(null!==(o=null!==(l=null!==(n=null!==(i=null==e?void 0:e.dataSourceId)&&void 0!==i?i:null==e?void 0:e.mainDataSourceId)&&void 0!==n?n:null==e?void 0:e.rootDataSourceId)&&void 0!==l?l:null==e?void 0:e.outputDataSourceId)&&void 0!==o?o:`ds_${t}`)}function x(i){const{widgetId:n,uds:l,dsKey:o,watchFields:r,queryFields:a,onUpdate:d}=i;return(0,e.jsx)(t.DataSourceComponent,{useDataSource:l,widgetId:n,children:t=>(0,e.jsx)(j,{ds:t,dsKey:o,watchFields:r,queryFields:a,onUpdate:d})})}function j(e){var i,n,l;const{ds:r,dsKey:a,watchFields:d,queryFields:s,onUpdate:u}=e;t.React.useEffect(()=>{var e;try{null===(e=null==r?void 0:r.setListenSelection)||void 0===e||e.call(r,!0)}catch(e){}},[r]);let c=(null===(i=null==r?void 0:r.getSelectedRecords)||void 0===i?void 0:i.call(r))||[];if(!c||0===c.length){const e=(null===(n=null==r?void 0:r.getRecords)||void 0===n?void 0:n.call(r))||[];e&&e.length&&(c=e)}const f=c.length?c[0]:null;let v=(null==f?void 0:f.getData)?f.getData():null;const p=function(e){var t;try{const i=null===(t=null==e?void 0:e.getSchema)||void 0===t?void 0:t.call(e),n=(null==i?void 0:i.fields)||{},l=Object.keys(n);if(!l.length)return null;const o=["tipo_soggetto","TIPO_SOGGETTO","tipoSoggetto","TipoSoggetto","tipo_sogg","TIPO_SOGG","tipo","TIPO"];for(const e of o)if(e&&n[e])return e;for(const e of l){const t=n[e],i=g((null==t?void 0:t.alias)||(null==t?void 0:t.label)||(null==t?void 0:t.title)||""),l=g(e);if(l.includes("tipo")&&l.includes("sogg")||i.includes("tipo soggetto")||i.includes("tipologia soggetto"))return e}return l.find(e=>{const t=g(e);return t.includes("tipo")&&t.includes("sogg")})||null}catch(e){return null}}(r);let y=null,m=null,h=null;try{p&&(null==f?void 0:f.getFieldValue)&&(y=f.getFieldValue(p))}catch(e){}try{p&&null!=y&&(m=function(e,t,i){var n,l,o,r,a;try{const d=null===(n=null==e?void 0:e.getSchema)||void 0===n?void 0:n.call(e),s=null===(l=null==d?void 0:d.fields)||void 0===l?void 0:l[t],u=null===(o=null==s?void 0:s.domain)||void 0===o?void 0:o.codedValues;if(!u||!Array.isArray(u))return null;for(const e of u){const t=null==e?void 0:e.code;if(t==i)return String(null!==(r=null==e?void 0:e.name)&&void 0!==r?r:"");if(String(t)===String(i))return String(null!==(a=null==e?void 0:e.name)&&void 0!==a?a:"")}return null}catch(e){return null}}(r,p,y))}catch(e){}h=b(y,m),p&&(v=Object.assign(Object.assign({},v||{}),{__tipo_soggetto_field:p,__tipo_soggetto_raw:y,__tipo_soggetto_label:m,__tipo_soggetto_kind:h}));const S=(null==r?void 0:r.getIdField)?r.getIdField():"OBJECTID",x=function(e,t){var i,n,l,o;return e?t&&null!=e[t]?e[t]:null!==(o=null!==(l=null!==(n=null!==(i=e.OBJECTID)&&void 0!==i?i:e.ObjectId)&&void 0!==n?n:e.objectid)&&void 0!==l?l:e.objectId)&&void 0!==o?o:null:null}(v,S),j=null!=x?Number(x):null,[w,R]=t.React.useState(null);t.React.useEffect(()=>{R(null)},[r,j]);const T=Array.isArray(s)?s.join("|"):"",I=Array.isArray(d)?d.join("|"):"";t.React.useEffect(()=>{let e=!1;return(()=>{o(this,void 0,void 0,function*(){if(!r||null==j||!Number.isFinite(j))return;const t=Array.isArray(s)?s:[],i=t.includes("*"),n=i?["*"]:Array.from(new Set([...t,...Array.isArray(d)?d:[]])).filter(Boolean),l=i||0===n.length?["*"]:n,o=v||{};if(i||l.some(e=>"*"!==e&&!Object.prototype.hasOwnProperty.call(o,e)))try{const t={where:`${S}=${Number(j)}`,outFields:l,returnGeometry:!1,pageSize:1},i=yield(null==r?void 0:r.query)?r.query(t):null;let n=null;Array.isArray(i)?n=i[0]:i&&Array.isArray(i.records)?n=i.records[0]:i&&i.data&&Array.isArray(i.data.records)&&(n=i.data.records[0]);const o=(null==n?void 0:n.getData)?n.getData():(null==n?void 0:n.data)||(null==n?void 0:n.attributes)||null;!e&&o&&R(o)}catch(e){}})})(),()=>{e=!0}},[r,j,S,T,I]);const z=w?Object.assign(Object.assign({},v||{}),w||{}):v,_=[];_.push(String(null!=j?j:""));for(const e of d)_.push(String(null!==(l=null==z?void 0:z[e])&&void 0!==l?l:""));const N=_.join("|");return t.React.useEffect(()=>{u(a,{ds:r,oid:null!=j&&Number.isFinite(j)?j:null,idFieldName:S,data:null!=j&&Number.isFinite(j)?z:null,sig:N})},[a,r,S,N]),null}function w(t){return(0,e.jsxs)("div",{style:{display:"grid",gridTemplateColumns:"200px 1fr",gap:12,alignItems:"baseline"},children:[(0,e.jsx)("div",{style:{fontSize:t.labelSize,color:"#6b7280",textAlign:"left"},children:t.label}),(0,e.jsx)("div",{style:{fontSize:t.valueSize,fontWeight:600,wordBreak:"break-word"},children:null!=t.value&&""!==t.value?String(t.value):"\u2014"})]})}function R(i){const[l,o]=t.React.useState(!1),[r,a]=t.React.useState(null),d=t.React.useRef(null),s=t.React.useRef(null),u=Array.isArray(i.options)?i.options:[],c=i.value?i.value:i.placeholder||"\u2014 seleziona \u2014",g=`${Math.max(0,Number(i.borderWidth)||0)}px solid ${i.borderColor||"rgba(0,0,0,0.10)"}`,f=t.React.useCallback(()=>{const e=d.current;if(!e)return;const t=(e.querySelector("button")||e).getBoundingClientRect(),i=window.innerHeight-t.bottom-8,n=t.top-8,l=i<180&&n>i,o=Math.min(280,Math.max(140,(l?n:i)-12));a({left:t.left,width:t.width,openUp:l,top:t.bottom+6,bottom:window.innerHeight-t.top+6,maxHeight:o})},[]);t.React.useEffect(()=>{if(!l)return;f();const e=e=>{const t=d.current,i=s.current;if(!t||!i)return;const n=e.target;t.contains(n)||i.contains(n)||o(!1)},t=e=>{"Escape"===(null==e?void 0:e.key)&&o(!1)},i=()=>f(),n=()=>f();return document.addEventListener("mousedown",e,!0),document.addEventListener("keydown",t,!0),window.addEventListener("resize",i,!0),window.addEventListener("scroll",n,!0),()=>{document.removeEventListener("mousedown",e,!0),document.removeEventListener("keydown",t,!0),window.removeEventListener("resize",i,!0),window.removeEventListener("scroll",n,!0)}},[l,f]);const v=l&&!i.disabled&&r?(0,n.createPortal)((0,e.jsxs)("div",{ref:s,style:{position:"fixed",left:r.left,width:r.width,top:r.openUp?"auto":r.top,bottom:r.openUp?r.bottom:"auto",zIndex:2e5,border:g,borderRadius:Math.max(0,Number(i.radius)||0),overflow:"hidden",boxShadow:"0 10px 30px rgba(0,0,0,0.12)",background:"#ffffff",maxHeight:r.maxHeight,overflowY:"auto"},children:[(0,e.jsx)("div",{onClick:()=>{i.onChange(""),o(!1)},style:{padding:"8px 10px",cursor:"pointer",fontSize:i.fontSize,backgroundColor:i.evenBg||"#ffffff",borderBottom:g,opacity:.9},title:"Svuota selezione",children:"\u2014 seleziona \u2014"}),u.map((t,n)=>{const l=n%2==0?i.evenBg||"#f6f7f9":i.oddBg||"#ffffff",r=String(t)===String(i.value||"");return(0,e.jsx)("div",{onClick:()=>{i.onChange(String(t)),o(!1)},style:{padding:"8px 10px",cursor:"pointer",fontSize:i.fontSize,backgroundColor:l,borderBottom:n===u.length-1?"none":g,fontWeight:r?700:400},children:String(t)},`${t}-${n}`)})]}),document.body):null,p=i.isError?"1px solid #b42318":"1px solid rgba(0,0,0,0.20)";return(0,e.jsxs)("div",{ref:d,style:{position:"relative",width:"100%"},children:[(0,e.jsxs)("button",{type:"button",disabled:!!i.disabled,onClick:()=>{i.disabled||o(e=>{const t=!e;return t&&f(),t})},style:{width:"100%",padding:"8px 10px",borderRadius:8,border:p,background:i.disabled?"#f3f4f6":"#ffffff",color:i.disabled?"#9ca3af":"#111827",cursor:i.disabled?"not-allowed":"pointer",textAlign:"left",display:"flex",alignItems:"center",gap:10},children:[(0,e.jsx)("span",{style:{flex:1,fontSize:i.fontSize},children:c}),(0,e.jsx)("span",{style:{fontSize:i.fontSize,opacity:.75},children:"\u25be"})]}),v]})}const T=1;function I(i){const{oid:l,data:r,ds:a,idFieldName:d,cfg:s,ui:u,onClose:c}=i,[g,f]=t.React.useState({}),[v,p]=t.React.useState([]),[b,y]=t.React.useState(!1);t.React.useEffect(()=>{let e=!1;return(()=>{o(this,void 0,void 0,function*(){var t,i,n;try{const i=null===(t=null==a?void 0:a.getSchema)||void 0===t?void 0:t.call(a),n=(null==i?void 0:i.fields)||{},l={};for(const e of Object.keys(n)){const t=n[e];l[e]=String((null==t?void 0:t.alias)||(null==t?void 0:t.label)||(null==t?void 0:t.title)||e)}!e&&Object.keys(l).length&&f(l)}catch(e){}try{const t=(null===(i=null==a?void 0:a.getLayer)||void 0===i?void 0:i.call(a))||(null===(n=null==a?void 0:a.getJSAPILayer)||void 0===n?void 0:n.call(a))||(null==a?void 0:a.layer)||null,l=yield Promise.resolve(t),o=l&&(l.layer||l)||null,r=(null==o?void 0:o.fields)||[];if(r.length&&!e){const e={},t=[];for(const i of r)(null==i?void 0:i.name)&&(e[i.name]=String((null==i?void 0:i.alias)||i.name),t.push({name:i.name,type:i.type||"",domain:i.domain||null}));f(e),p(t)}}catch(e){}e||y(!0)})})(),()=>{e=!0}},[a]);const[m,h]=t.React.useState(Object.assign({},r)),[S,x]=t.React.useState(!1),[j,w]=t.React.useState(null),[R,T]=t.React.useState(!1),[I,z]=t.React.useState("anagrafica"),_=(e,t)=>h(i=>Object.assign(Object.assign({},i),{[e]:t})),N=[],A=[],C=Object.keys(r||{}).filter(e=>!(e.startsWith("__")||/^objectid$/i.test(e)||/^globalid$/i.test(e)||/^shape/i.test(e)||/^stato_/i.test(e)||/^esito_/i.test(e)||/^presa_in_carico/i.test(e)||/^dt_/i.test(e)||/^GII_/i.test(e)||/^origine_pratica$/i.test(e))),F=/ditta|denom|ragione|nome|cognome|cf|cod.*fisc|piva|partita|indir|via|cap|comune|prov|telefono|cell|mail|pec|tipologia_sogg|tipo_sogg/i,D=/viol|infraz|descr|art|norm|tipo_preliev|sanz|acqua|volume|turno|utenza|contatore|circostanz|fatti|ufficio|settore|area_cod/i;for(const e of C)F.test(e)?N.push(e):D.test(e)&&A.push(e);const k=new Set([...N,...A]);for(const e of C)k.has(e)||A.push(e);const B=t=>{if(!b)return null;const i=v.find(e=>e.name===t),n=g[t]||t,l=(null==i?void 0:i.type)||"esriFieldTypeString",o=(null==i?void 0:i.domain)||null,r=m[t],a=l.toLowerCase().includes("date"),d=l.toLowerCase().includes("integer")||l.toLowerCase().includes("double");if((null==o?void 0:o.codedValues)&&Array.isArray(o.codedValues))return(0,e.jsxs)("div",{style:{display:"grid",gap:4},children:[(0,e.jsx)("div",{style:{fontSize:12,color:"#6b7280"},children:n}),(0,e.jsxs)("select",{value:null!=r?r:"",disabled:S,onChange:e=>_(t,""===e.target.value?null:d?Number(e.target.value):e.target.value),style:{padding:"7px 10px",borderRadius:8,border:"1px solid rgba(0,0,0,0.20)",fontSize:13,width:"100%",background:S?"#f3f4f6":"#fff"},children:[(0,e.jsx)("option",{value:"",children:"\u2014 seleziona \u2014"}),o.codedValues.map(t=>(0,e.jsx)("option",{value:String(t.code),children:t.name},String(t.code)))]})]},t);if(a){const i=e=>{if(!e)return"";try{const t=Number(e),i=Number.isFinite(t)&&t>0?new Date(t):new Date(String(e));return Number.isNaN(i.getTime())?"":`${i.getFullYear()}-${String(i.getMonth()+1).padStart(2,"0")}-${String(i.getDate()).padStart(2,"0")}`}catch(e){return""}};return(0,e.jsxs)("div",{style:{display:"grid",gap:4},children:[(0,e.jsx)("div",{style:{fontSize:12,color:"#6b7280"},children:n}),(0,e.jsx)("input",{type:"date",value:i(r),disabled:S,onChange:e=>{const i=new Date(e.target.value);_(t,Number.isNaN(i.getTime())?null:i.getTime())},style:{padding:"7px 10px",borderRadius:8,border:"1px solid rgba(0,0,0,0.20)",fontSize:13,width:"100%",background:S?"#f3f4f6":"#fff"}})]},t)}const s=/descr|note|fatti|circostanz/i.test(t);return(0,e.jsxs)("div",{style:{display:"grid",gap:4},children:[(0,e.jsx)("div",{style:{fontSize:12,color:"#6b7280"},children:n}),s?(0,e.jsx)("textarea",{value:null!=r?String(r):"",disabled:S,rows:3,onChange:e=>_(t,e.target.value||null),style:{padding:"7px 10px",borderRadius:8,border:"1px solid rgba(0,0,0,0.20)",fontSize:13,width:"100%",resize:"vertical",background:S?"#f3f4f6":"#fff",boxSizing:"border-box"}}):(0,e.jsx)("input",{type:"text",value:null!=r?String(r):"",disabled:S,onChange:e=>_(t,""===e.target.value?null:d?Number(e.target.value):e.target.value),style:{padding:"7px 10px",borderRadius:8,border:"1px solid rgba(0,0,0,0.20)",fontSize:13,width:"100%",background:S?"#f3f4f6":"#fff",boxSizing:"border-box"}})]},t)},E=(()=>{var e;const t=null!==(e=null==r?void 0:r.origine_pratica)&&void 0!==e?e:null==r?void 0:r.Origine_pratica;return`${2===t||"2"===t?"TI":"TR"}-${l}`})(),O=(0,e.jsxs)("div",{style:{position:"fixed",inset:0,zIndex:99999,background:"rgba(0,0,0,0.55)",display:"flex",alignItems:"center",justifyContent:"center"},children:[(0,e.jsxs)("div",{style:{background:"#fff",borderRadius:12,width:"88vw",maxWidth:860,height:"85vh",maxHeight:"85vh",display:"flex",flexDirection:"column",overflow:"hidden",boxShadow:"0 20px 60px rgba(0,0,0,0.3)"},children:[(0,e.jsxs)("div",{style:{flex:"0 0 auto",padding:"14px 20px",borderBottom:"1px solid #e5e7eb",display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[(0,e.jsxs)("div",{style:{fontWeight:700,fontSize:15},children:["\u270f\ufe0f Modifica pratica\xa0",(0,e.jsx)("span",{style:{color:"#2f6fed"},children:E})]}),(0,e.jsxs)("div",{style:{display:"flex",gap:10,alignItems:"center"},children:[j&&(0,e.jsx)("span",{style:{fontSize:13,color:"ok"===j.kind?"#1a7f37":"#b42318"},children:j.text}),(0,e.jsx)("button",{type:"button",disabled:S,onClick:()=>o(this,void 0,void 0,function*(){var e,i,n,r;x(!0),w(null);try{const s=yield function(e){return o(this,void 0,void 0,function*(){var i,n,l,o;if(!e)return null;try{const t=(null===(i=null==e?void 0:e.getLayer)||void 0===i?void 0:i.call(e))||(null===(n=null==e?void 0:e.getJSAPILayer)||void 0===n?void 0:n.call(e))||(null===(l=null==e?void 0:e.getJsApiLayer)||void 0===l?void 0:l.call(e))||(null==e?void 0:e.layer)||null,o=yield Promise.resolve(t),r=o&&(o.layer||o)||null;if(r&&"function"==typeof r.applyEdits)return r}catch(e){}try{const i=t.DataSourceManager.getInstance(),n=(null==e?void 0:e.id)?i.getDataSource(e.id):null;if(n){const e=(null===(o=null==n?void 0:n.getLayer)||void 0===o?void 0:o.call(n))||(null==n?void 0:n.layer)||null,t=yield Promise.resolve(e),i=t&&(t.layer||t)||null;if(i&&"function"==typeof i.applyEdits)return i}}catch(e){}return null})}(a);if(!(null==s?void 0:s.applyEdits))throw new Error("Layer non raggiungibile.");if("function"==typeof s.load)try{yield s.load()}catch(e){}const u={[d]:l};for(const[e,t]of Object.entries(m))e.startsWith("__")||(u[e]=t);const g=function(e,t){const i=(null==t?void 0:t.fields)||[];if(!i.length)return e;const n=new Set(i.map(e=>String(e.name))),l={};for(const t of Object.keys(e))n.has(t)&&(l[t]=e[t]);return l}(u,s),f=yield s.applyEdits({updateFeatures:[{attributes:g}]}),v=(null===(e=null==f?void 0:f.updateFeatureResults)||void 0===e?void 0:e[0])||(null===(i=null==f?void 0:f.updateResults)||void 0===i?void 0:i[0])||null,p=null==v?void 0:v.error;if(!(!p&&(!0===(null==v?void 0:v.success)||null!=(null==v?void 0:v.objectId)||null==(null==v?void 0:v.success)))){const e=p?`${null!==(n=p.code)&&void 0!==n?n:""}: ${null!==(r=p.message)&&void 0!==r?r:""}`:JSON.stringify(f);throw new Error(e)}yield function(e){return o(this,void 0,void 0,function*(){var t,i;if(!e)return;let n=e;try{for(;null==n?void 0:n.belongToDataSource;)n=n.belongToDataSource}catch(e){}const l=n?[n]:[];try{const e=(null===(t=null==n?void 0:n.getAllDerivedDataSources)||void 0===t?void 0:t.call(n))||[];(null==e?void 0:e.length)&&l.push(...e)}catch(e){}for(const e of l)try{const t=(null===(i=e.getCurrentQueryParams)||void 0===i?void 0:i.call(e))||null;e.clearSourceRecords&&e.clearSourceRecords(),e.addVersion&&e.addVersion(),e.load&&(t?yield e.load(t):yield e.load())}catch(e){}})}(a),w({kind:"ok",text:"Salvato."}),x(!1),window.setTimeout(()=>c(!0),1e3)}catch(e){x(!1),w({kind:"err",text:`Errore: ${(null==e?void 0:e.message)||String(e)}`})}}),style:{padding:"8px 18px",borderRadius:8,border:"none",background:S?"#e5e7eb":"#1a7f37",color:S?"#9ca3af":"#fff",fontWeight:700,fontSize:13,cursor:S?"not-allowed":"pointer"},children:S?"Salvataggio\u2026":"\u{1f4be} Salva"}),(0,e.jsx)("button",{type:"button",disabled:S,onClick:()=>T(!0),style:{padding:"8px 18px",borderRadius:8,border:"1px solid #d13438",background:"#fff",color:"#d13438",fontWeight:700,fontSize:13,cursor:S?"not-allowed":"pointer"},children:"\u2715 Annulla"})]})]}),(0,e.jsxs)("div",{style:{flex:"0 0 auto",display:"flex",gap:8,padding:"10px 20px",borderBottom:"1px solid #e5e7eb"},children:[["anagrafica","violazione"].map(t=>(0,e.jsx)("button",{type:"button",disabled:S,onClick:()=>z(t),style:{padding:"8px 14px",borderRadius:10,border:"1px solid "+(I===t?"#2f6fed":"rgba(0,0,0,0.12)"),background:I===t?"#eaf2ff":"rgba(0,0,0,0.02)",color:I===t?"#1d4ed8":"#111827",fontWeight:700,fontSize:12,cursor:S?"not-allowed":"pointer"},children:t.charAt(0).toUpperCase()+t.slice(1)},t)),(0,e.jsx)("div",{style:{fontSize:12,color:"#9ca3af",alignSelf:"center",marginLeft:8},children:'Per localizzazione e allegati usa "Modifica (pagina)"'})]}),(0,e.jsx)("div",{style:{flex:"1 1 auto",minHeight:0,overflowY:"auto",padding:"16px 20px"},children:b?(0,e.jsxs)("div",{style:{display:"grid",gap:14},children:["anagrafica"===I&&(N.length?N.map(e=>B(e)):(0,e.jsx)("div",{style:{color:"#6b7280",fontSize:13},children:"Nessun campo rilevato automaticamente. Usare la pagina di editing completa."})),"violazione"===I&&(A.length?A.map(e=>B(e)):(0,e.jsx)("div",{style:{color:"#6b7280",fontSize:13},children:"Nessun campo rilevato automaticamente. Usare la pagina di editing completa."}))]}):(0,e.jsx)("div",{style:{color:"#6b7280",fontSize:13},children:"Caricamento schema campi\u2026"})})]}),R&&(0,e.jsx)("div",{style:{position:"fixed",inset:0,zIndex:1e5,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center"},children:(0,e.jsxs)("div",{style:{background:"#fff",borderRadius:12,padding:28,maxWidth:380,width:"90%",boxShadow:"0 8px 32px rgba(0,0,0,0.25)"},children:[(0,e.jsx)("div",{style:{fontWeight:700,fontSize:16,marginBottom:10},children:"Annullare le modifiche?"}),(0,e.jsx)("div",{style:{fontSize:13,color:"#4b5563",marginBottom:20},children:"Le modifiche non salvate andranno perse."}),(0,e.jsxs)("div",{style:{display:"flex",gap:10},children:[(0,e.jsx)("button",{type:"button",onClick:()=>{T(!1),c(!1)},style:{padding:"8px 18px",borderRadius:8,border:"none",background:"#d13438",color:"#fff",fontWeight:700,fontSize:13,cursor:"pointer"},children:"S\xec, annulla"}),(0,e.jsx)("button",{type:"button",onClick:()=>T(!1),style:{padding:"8px 18px",borderRadius:8,border:"1px solid rgba(0,0,0,0.15)",background:"#fff",color:"#111827",fontWeight:600,fontSize:13,cursor:"pointer"},children:"Torna all'editing"})]})]})})]});return(0,n.createPortal)(O,document.body)}const z=2,_=1,N=2,A=3,C=4,F=5,D=1,k=2,B=3;function E(e){return e===D?A:e===k?C:e===B?F:null}function O(e,t){const i=String(null!=e?e:"").trim();return i&&function(e){return/^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test((e||"").trim())}(i)?i:t}function P(e,t,i){var n,l,o,r,a;const d={borderRadius:null!==(n=null==i?void 0:i.btnBorderRadius)&&void 0!==n?n:8,fontSize:null!==(l=null==i?void 0:i.btnFontSize)&&void 0!==l?l:13,fontWeight:null!==(o=null==i?void 0:i.btnFontWeight)&&void 0!==o?o:600,padding:`${null!==(r=null==i?void 0:i.btnPaddingY)&&void 0!==r?r:8}px ${null!==(a=null==i?void 0:i.btnPaddingX)&&void 0!==a?a:16}px`};return t?Object.assign(Object.assign({},d),{backgroundColor:"#e5e7eb",borderColor:"#e5e7eb",color:"#9ca3af",cursor:"not-allowed"}):Object.assign(Object.assign({},d),{backgroundColor:e,borderColor:e,color:"#ffffff"})}function $(n){var l,r,a,d,g,f;const{active:v,roleCode:p,buttonText:b,buttonColors:S,ui:x}=n,j=String(p||"DT").trim().toUpperCase(),O=x.titleFontSize,$=x.msgFontSize,L=`presa_in_carico_${j}`,W=`dt_presa_in_carico_${j}`,M=`stato_${j}`,G=`dt_stato_${j}`,J=`esito_${j}`,U=`dt_esito_${j}`,H=`note_${j}`,q="stato_DA",V="dt_stato_DA",Z="presa_in_carico_DA",[Y,K]=t.React.useState(!1),[X,Q]=t.React.useState({kind:"info",text:"Selezionare una riga."}),[ee,te]=t.React.useState(null),[ie,ne]=t.React.useState(!1),[le,oe]=t.React.useState(""),[re,ae]=t.React.useState(""),de=t.React.useRef(""),se=t.React.useRef(null),ue=t.React.useCallback(e=>{if(e)try{e.style.height="auto";const t=Math.min(e.scrollHeight||42,118);e.style.height=`${t}px`,e.style.overflowY=e.scrollHeight>118?"auto":"hidden"}catch(e){}},[]),ce=null!=(null===(l=null==v?void 0:v.state)||void 0===l?void 0:l.oid)?`${v.key}:${v.state.oid}`:null,ge=t.React.useRef(ce);t.React.useEffect(()=>{ge.current=ce},[ce]);const fe=null===(r=null==v?void 0:v.state)||void 0===r?void 0:r.ds,ve=(null===(a=null==v?void 0:v.state)||void 0===a?void 0:a.data)||null,pe=null!==(g=null===(d=null==v?void 0:v.state)||void 0===d?void 0:d.oid)&&void 0!==g?g:null,be=(null===(f=null==v?void 0:v.state)||void 0===f?void 0:f.idFieldName)||"OBJECTID",ye=null!=pe&&Number.isFinite(pe),me=t.React.useRef(`sess-${Date.now()}-${Math.random().toString(16).slice(2)}`),he=(e,t)=>{if(!e)return;const i={};try{Object.keys(e).forEach(e=>{i[String(e).toLowerCase()]=e})}catch(e){}for(const n of t){const t=e[n];if(null!=t&&""!==t)return t;const l=i[String(n).toLowerCase()];if(l){const t=e[l];if(null!=t&&""!==t)return t}}},Se=e=>o(this,void 0,void 0,function*(){var t,i,n,l,o,r,a,d;try{const u=new(yield c("esri/layers/FeatureLayer"))({url:s,outFields:["*"]});"function"==typeof u.load&&(yield u.load());const g=y({parent_globalid:e.parentGlobalId||"00000000-0000-0000-0000-000000000000",parent_objectid:e.parentOid,dt_evento:Date.now(),ruolo:e.ruolo,area:null!==(t=e.area)&&void 0!==t?t:"",settore:null!==(i=e.settore)&&void 0!==i?i:"",operazione:"UPDATE",campo:e.campo,valore_precedente:null!=e.valorePrev?String(e.valorePrev):"",valore_nuovo:null!=e.valoreNew?String(e.valoreNew):"",session_id:me.current,note:null!==(n=e.note)&&void 0!==n?n:""},u),f=yield u.applyEdits({addFeatures:[{attributes:g}]}),v=(null===(l=null==f?void 0:f.addFeatureResults)||void 0===l?void 0:l[0])||(null===(o=null==f?void 0:f.addResults)||void 0===o?void 0:o[0])||null,p=null==v?void 0:v.error;if(!(!p&&(!0===(null==v?void 0:v.success)||null!=(null==v?void 0:v.objectId)||null!=(null==v?void 0:v.globalId)||null==(null==v?void 0:v.success)))){const e=p?`code=${null!==(r=p.code)&&void 0!==r?r:""} name=${null!==(a=p.name)&&void 0!==a?a:""} message=${null!==(d=p.message)&&void 0!==d?d:""}`:JSON.stringify(f||v);throw new Error(e)}}catch(e){console.warn("[GII_LOG] Errore scrittura log presa in carico:",e)}}),xe=n.editConfig,[je,we]=t.React.useState(!1),Re=ve?ve[xe.fieldStatoTI]:null,Te=ve?ve[xe.fieldPresaTI]:null,Ie=null!=Re&&""!==String(Re)?Number(Re):null,ze=null!=Te&&""!==String(Te)?Number(Te):null,_e=ye&&!Y&&null===ee&&xe.show&&ze===xe.presaRequiredVal&&null!=Ie&&Ie>=xe.minStato&&Ie<=xe.maxStato,Ne=ve?ve[L]:null,Ae=ve?ve[M]:null,Ce=ve?ve[J]:null,Fe=ve?ve[q]:null,De=null!=Ne&&""!==String(Ne)?Number(Ne):null,ke=null!=Ae&&""!==String(Ae)?Number(Ae):null,Be=null!=Fe&&""!==String(Fe)?Number(Fe):null,Ee=ve?ve.origine_pratica:null,Oe=null!=Ee&&""!==String(Ee)?Number(Ee):null,Pe="DT"===j&&null!=Be&&Be>=1;t.React.useEffect(()=>{if(!ce)return Q({kind:"info",text:"Selezionare una riga."}),te(null),K(!1),ne(!1),de.current="",oe(""),void ae("");Q(null),te(null),K(!1),ne(!1);const e=ve&&null!=ve[H]?String(ve[H]):"";de.current=e,oe(e),ae(""),window.setTimeout(()=>ue(se.current),0)},[ce]),t.React.useEffect(()=>{const e=window.setTimeout(()=>ue(se.current),0);return()=>window.clearTimeout(e)},[le,ue]);const $e=(null!=ee||Y)&&ye,Le=ve?(e=>{if(!e)return"";const t=["DA","DT","RI","RZ","TI","TR"],i=t=>{const i=e[`presa_in_carico_${t}`],n=e[`stato_${t}`],l=e[`esito_${t}`];return null!=i&&""!==i||null!=n&&""!==n||null!=l&&""!==l};for(const n of t){if(!i(n))continue;const t=e[`presa_in_carico_${n}`],l=e[`stato_${n}`],o=e[`esito_${n}`],r=(null!=t&&""!==t&&Number(t),null!=l&&""!==l&&Number(l),null!=o&&""!==o?Number(o):null);return null!==r&&Number.isFinite(r),n}const n=e.origine_pratica;return 2===(null!=n&&""!==n?Number(n):null)?"TI":"RZ"})(ve):"",We=Le===j,Me=ye&&!Y&&!Pe&&null===ee&&We&&!("TI"===j&&2===Oe&&null==De)&&(null==De||De===T)&&(null==ke||ke===_),Ge=ye&&!Y&&!Pe&&null===ee&&We&&De===z&&ke===N,Je="DT"===j&&ye&&!Y&&!Pe&&null===ee&&We&&(ke===A||ke===C||ke===F)&&(null==Be||0===Be),Ue="INTEGRAZIONE"===ee||"RESPINGI"===ee,He=Ue&&ye&&!Y&&!Pe,qe=String(null!=le?le:"").trim(),Ve=String(null!=re?re:"").trim(),Ze=/\baltro\b/i.test(Ve),Ye="INTEGRAZIONE"===ee||"RESPINGI"===ee&&Ze,Ke=ie&&("RESPINGI"===ee&&!Ve),Xe=ie&&(Ye&&!qe),Qe=e=>{ye&&(Pe||("TAKE"!==e||Me)&&("TAKE"===e||"TRASMETTI"===e||Ge)&&("TRASMETTI"!==e||Je)&&(te(e),Q(null),ne(!1),ae(""),"INTEGRAZIONE"===e&&window.setTimeout(()=>{var e,t;try{null===(t=null===(e=se.current)||void 0===e?void 0:e.focus)||void 0===t||t.call(e)}catch(e){}ue(se.current)},0)))},et=e=>{let t=e;try{for(;null==t?void 0:t.belongToDataSource;)t=t.belongToDataSource}catch(e){}return t||e},tt=e=>o(this,void 0,void 0,function*(){var t,i,n,l,o,r;const a=et(e),d=(null===(t=null==a?void 0:a.getLayer)||void 0===t?void 0:t.call(a))||(null===(i=null==a?void 0:a.getJSAPILayer)||void 0===i?void 0:i.call(a))||(null==a?void 0:a.layer)||(null===(n=null==a?void 0:a.createJSAPILayerByDataSource)||void 0===n?void 0:n.call(a))||(null===(l=null==e?void 0:e.getLayer)||void 0===l?void 0:l.call(e))||(null===(o=null==e?void 0:e.getJSAPILayer)||void 0===o?void 0:o.call(e))||(null==e?void 0:e.layer)||(null===(r=null==e?void 0:e.createJSAPILayerByDataSource)||void 0===r?void 0:r.call(e))||null;return{root:a,layer:u(yield Promise.resolve(d))}}),it=(e,t)=>o(this,void 0,void 0,function*(){var i;let n="";try{const t=yield c("esri/identity/IdentityManager"),i=yield t.getCredential(e);n=(null==i?void 0:i.token)||""}catch(e){}const l=JSON.stringify({attributes:t}),o=new URLSearchParams(Object.assign({f:"json",features:`[${l}]`,rollbackOnFailure:"true"},n?{token:n}:{})),r=`${e.replace(/\/$/,"")}/updateFeatures`,a=yield fetch(r,{method:"POST",body:o});if(!a.ok)throw new Error(`HTTP ${a.status}`);const d=yield a.json();if(d.error)throw new Error(`REST error: code=${d.error.code} \u2013 ${d.error.message}`);const s=null===(i=d.updateResults)||void 0===i?void 0:i[0];if(s&&!s.success){const e=s.error;throw new Error(e?`code=${e.code} \u2013 ${e.description||e.message}`:JSON.stringify(s))}}),nt=(e,t)=>o(this,void 0,void 0,function*(){var i,l,o,r,a,d;if(!fe)throw new Error("DataSource non disponibile.");if(!ye||null==pe)throw new Error("Selezione non valida.");const s=ge.current;K(!0),Q({kind:"info",text:"Aggiorno\u2026"});try{const u=n.motherLayerUrl?String(n.motherLayerUrl).trim():"",c=et(fe);if(u){const t=be||"OBJECTID",i=Object.assign({[t]:pe},e);yield it(u,i)}else{const{layer:t}=yield tt(fe);if(!(null==t?void 0:t.applyEdits))throw new Error("Layer non disponibile (applyEdits).");if("function"==typeof t.load)try{yield t.load()}catch(e){}const n=((null===(i=et(fe))||void 0===i?void 0:i.getIdField)?et(fe).getIdField():null)||((null==fe?void 0:fe.getIdField)?fe.getIdField():null)||t.objectIdField||be||"OBJECTID",s=y(Object.assign({[n]:pe},e),t),u=yield t.applyEdits({updateFeatures:[{attributes:s}]}),c=(null===(l=null==u?void 0:u.updateFeatureResults)||void 0===l?void 0:l[0])||(null===(o=null==u?void 0:u.updateResults)||void 0===o?void 0:o[0])||null,g=null==c?void 0:c.error;if(!(!g&&(!0===(null==c?void 0:c.success)||null!=(null==c?void 0:c.objectId)||null!=(null==c?void 0:c.globalId)||null==(null==c?void 0:c.success)))){const e=g?`code=${null!==(r=g.code)&&void 0!==r?r:""} name=${null!==(a=g.name)&&void 0!==a?a:""} message=${null!==(d=g.message)&&void 0!==d?d:""}`:JSON.stringify(u||c);throw new Error(e)}}if(ge.current!==s)return Q(null),void K(!1);Q({kind:"ok",text:t}),yield m(c),yield m(fe),window.setTimeout(()=>{ge.current===s&&Q(null)},4500),K(!1)}catch(e){throw K(!1),e}}),lt=(e,t)=>o(this,void 0,void 0,function*(){try{const i=E(e),n={[J]:e,[U]:Date.now()};null!=i&&(n[M]=i,n[G]=Date.now()),yield nt(n,`Esito salvato: ${t}.`),te(null),ne(!1)}catch(e){const t=(null==e?void 0:e.message)?String(e.message):String(e);Q({kind:"err",text:`Errore salvataggio: ${t}`})}}),ot=(e,t)=>e?{fontSize:x.statusFontSize,color:t?"#b42318":"#6b7280"}:{display:"none"};return(0,e.jsxs)("div",{children:[$e&&(0,e.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0,0,0,0.10)",zIndex:1e3}}),(0,e.jsxs)("div",{style:{position:"relative",zIndex:1001,display:"flex",flexDirection:"column",gap:12,boxSizing:"border-box",width:"100%",height:"100%",minHeight:0},children:[(0,e.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",gap:12},children:[(0,e.jsxs)("div",{style:{fontSize:O,fontWeight:700},children:["Azioni (",j,")"]}),X&&(0,e.jsx)("div",{style:h(X.kind,$),title:X.text,children:X.text})]}),(0,e.jsxs)("div",{style:{display:"grid",gap:6},children:[(0,e.jsx)(w,{label:"N.pratica (OID)",value:pe,labelSize:x.statusFontSize,valueSize:O}),(0,e.jsx)(w,{label:L,value:Ne,labelSize:x.statusFontSize,valueSize:O}),(0,e.jsx)(w,{label:M,value:Ae,labelSize:x.statusFontSize,valueSize:O}),(0,e.jsx)(w,{label:J,value:Ce,labelSize:x.statusFontSize,valueSize:O}),(0,e.jsx)(w,{label:q,value:Fe,labelSize:x.statusFontSize,valueSize:O})]}),(0,e.jsx)("div",{style:{height:1,background:x.dividerColor,margin:"2px 0"}}),null===ee&&(0,e.jsx)("div",{style:{display:"flex",alignItems:"baseline",gap:10},children:(0,e.jsx)("div",{style:{fontSize:O,fontWeight:700},children:"Azioni"})}),null===ee&&(0,e.jsxs)("div",{style:{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"},children:[(0,e.jsx)(i.Button,{type:"primary",onClick:()=>Qe("TAKE"),disabled:!Me,style:P(S.take,!Me,x),children:b}),(0,e.jsx)(i.Button,{type:"primary",onClick:()=>Qe("INTEGRAZIONE"),disabled:!Ge,style:P(S.integrazione,!Ge,x),children:"Integrazione"}),(0,e.jsx)(i.Button,{type:"primary",onClick:()=>Qe("APPROVA"),disabled:!Ge,style:P(S.approva,!Ge,x),children:"Approva"}),(0,e.jsx)(i.Button,{type:"primary",onClick:()=>Qe("RESPINGI"),disabled:!Ge,style:P(S.respingi,!Ge,x),children:"Respingi"}),"DT"===j&&(0,e.jsx)(i.Button,{type:"primary",onClick:()=>Qe("TRASMETTI"),disabled:!Je,style:P(S.trasmetti,!Je,x),children:"Trasmetti a DA"}),xe.show&&(0,e.jsxs)(e.Fragment,{children:[(0,e.jsx)("div",{style:{width:"100%",height:1,background:x.dividerColor,margin:"4px 0"}}),(0,e.jsx)("button",{type:"button",disabled:!_e,onClick:()=>{var e,t,i,n;if(_e){try{window.__giiEdit={oid:pe,data:Object.assign({},ve),idFieldName:(null===(e=null==v?void 0:v.state)||void 0===e?void 0:e.idFieldName)||"OBJECTID",dsId:null!==(n=null===(i=null===(t=null==v?void 0:v.state)||void 0===t?void 0:t.ds)||void 0===i?void 0:i.id)&&void 0!==n?n:null,ts:Date.now()}}catch(e){}we(!0)}},title:_e?"Apre il pannello di editing nella pagina corrente":"Modifica non disponibile: verifica stato e presa in carico TI",style:{padding:"8px 16px",borderRadius:8,border:"none",background:_e?xe.overlayColor:"#e5e7eb",color:_e?"#fff":"#9ca3af",fontWeight:700,fontSize:13,cursor:_e?"pointer":"not-allowed",display:"flex",alignItems:"center",gap:6},children:"\u270f\ufe0f Modifica (overlay)"}),(0,e.jsx)("button",{type:"button",disabled:!_e,onClick:()=>{var e,t,i,n,l,o;if(_e){try{window.__giiEdit={oid:pe,data:Object.assign({},ve),idFieldName:(null===(e=null==v?void 0:v.state)||void 0===e?void 0:e.idFieldName)||"OBJECTID",dsId:null!==(n=null===(i=null===(t=null==v?void 0:v.state)||void 0===t?void 0:t.ds)||void 0===i?void 0:i.id)&&void 0!==n?n:null,ts:Date.now()}}catch(e){}try{const e=String(xe.pageId||"editing-ti").trim(),t=null===(l=window.jimuCore)||void 0===l?void 0:l.getAppStore;if(t){const i=t();return void(null===(o=null==i?void 0:i.dispatch)||void 0===o||o.call(i,{type:"APP_NAVIGATE",uri:e}))}}catch(e){}try{const e=String(xe.pageId||"editing-ti").trim();window.location.hash=`#${e}`}catch(e){}}},title:_e?`Apre la pagina di editing: ${xe.pageId}`:"Modifica non disponibile: verifica stato e presa in carico TI",style:{padding:"8px 16px",borderRadius:8,border:`2px solid ${_e?xe.pageColor:"#e5e7eb"}`,background:"#fff",color:_e?xe.pageColor:"#9ca3af",fontWeight:700,fontSize:13,cursor:_e?"pointer":"not-allowed",display:"flex",alignItems:"center",gap:6},children:"\u2197 Modifica (pagina)"})]})]}),je&&ye&&null!=pe&&null!=ve&&(0,e.jsx)(I,{oid:pe,data:ve,ds:fe,idFieldName:be,cfg:xe,ui:x,onClose:e=>{we(!1),e&&(Q({kind:"ok",text:"Pratica modificata."}),window.setTimeout(()=>Q(null),4e3))}}),null!==ee&&(0,e.jsxs)("div",{style:{display:"grid",gap:10},children:["RESPINGI"===ee&&(0,e.jsxs)("div",{style:{display:"grid",gap:6},children:[(0,e.jsxs)("div",{style:{display:"flex",alignItems:"baseline",gap:8},children:[(0,e.jsx)("div",{style:{fontSize:O,fontWeight:700},children:"Motivazione"}),(0,e.jsx)("div",{style:ot(!0,Ke),children:"(obbligatoria)"})]}),(0,e.jsx)(R,{value:re,options:x.rejectReasons||[],placeholder:"\u2014 seleziona \u2014",disabled:Y||!ye||Pe,onChange:e=>{const t=String(null!=e?e:"");ae(t),ie&&ne(!1)},evenBg:x.reasonsZebraEvenBg,oddBg:x.reasonsZebraOddBg,borderColor:x.reasonsRowBorderColor,borderWidth:x.reasonsRowBorderWidth,radius:x.reasonsRowRadius,fontSize:x.statusFontSize,isError:Ke})]}),Ue&&(0,e.jsxs)("div",{style:{display:"grid",gap:6},children:[(0,e.jsxs)("div",{style:{display:"flex",alignItems:"baseline",gap:8},children:[(0,e.jsx)("div",{style:{fontSize:O,fontWeight:700},children:"Note"}),"INTEGRAZIONE"===ee&&(0,e.jsx)("div",{style:ot(!0,Xe),children:"(obbligatoria)"}),"RESPINGI"===ee&&Ye&&(0,e.jsx)("div",{style:ot(!0,Xe),children:"(obbligatoria)"})]}),(0,e.jsx)("textarea",{ref:se,value:le,onChange:e=>{var t;const i=String(null!==(t=e.target.value)&&void 0!==t?t:"");oe(i),ue(e.target)},placeholder:"INTEGRAZIONE"===ee?"Scrivi la richiesta di integrazione\u2026":Ye?"Specifica il motivo (Altro)\u2026":"Nota facoltativa (eventuali dettagli)\u2026",style:{width:"100%",minHeight:42,maxHeight:118,overflowY:"hidden",resize:"none",padding:"8px 10px",borderRadius:8,border:Xe?"1px solid #b42318":"1px solid rgba(0,0,0,0.20)",fontSize:x.statusFontSize,outline:"none",boxSizing:"border-box"},disabled:!He})]}),(0,e.jsxs)("div",{style:{display:"flex",gap:10,flexWrap:"wrap",alignItems:"center"},children:["TAKE"===ee&&(0,e.jsx)(i.Button,{type:"primary",onClick:()=>o(this,void 0,void 0,function*(){try{const e=De;yield nt({[L]:z,[W]:Date.now(),[M]:N,[G]:Date.now()},"Presa in carico salvata.");const t=String(he(ve,["globalid","global_id","GlobalID","GLOBALID","parent_globalid"])||"00000000-0000-0000-0000-000000000000"),i=he(ve,["area","area_cod","cod_area"]),n=he(ve,["settore","settore_cod","cod_settore"])||(e=>{const t=String(e||"").toUpperCase().match(/(D[1-6]|DS|CR)/);return t?t[1]:""})(String(he(ve,["creator","Creator","editor","Editor"])||""));Se({parentOid:pe,parentGlobalId:t,ruolo:j,area:null!=i?String(i):"",settore:null!=n?String(n):"",campo:L,valorePrev:e,valoreNew:z,note:`Presa in carico (${j})`}),te(null),ne(!1)}catch(e){const t=(null==e?void 0:e.message)?String(e.message):String(e);Q({kind:"err",text:`Errore salvataggio: ${t}`})}}),disabled:Y,style:P(S.take,!!Y,x),children:Y?"Aggiorno\u2026":"Conferma presa in carico"}),"INTEGRAZIONE"===ee&&(0,e.jsx)(i.Button,{type:"primary",onClick:()=>o(this,void 0,void 0,function*(){if(ne(!0),qe)try{const e=E(D);yield nt({[J]:D,[U]:Date.now(),[M]:null!=e?e:A,[G]:Date.now(),[H]:qe},"Integrazione richiesta salvata."),te(null),ne(!1)}catch(e){const t=(null==e?void 0:e.message)?String(e.message):String(e);Q({kind:"err",text:`Errore salvataggio: ${t}`})}}),disabled:Y,style:P(S.integrazione,!!Y,x),children:Y?"Aggiorno\u2026":"Conferma integrazione"}),"APPROVA"===ee&&(0,e.jsx)(i.Button,{type:"primary",onClick:()=>lt(k,"Approvata"),disabled:Y,style:P(S.approva,!!Y,x),children:Y?"Aggiorno\u2026":"Conferma approvazione"}),"RESPINGI"===ee&&(0,e.jsx)(i.Button,{type:"primary",onClick:()=>o(this,void 0,void 0,function*(){if(ne(!0),Ve&&(!Ye||qe))try{const e=E(B),t=Ze?`Motivazione: ${Ve}\n\n${qe}`:`Motivazione: ${Ve}`+(qe?`\n\n${qe}`:""),i={[J]:B,[U]:Date.now(),[H]:t};null!=e&&(i[M]=e,i[G]=Date.now()),yield nt(i,"Esito salvato: Respinta."),te(null),ne(!1)}catch(e){const t=(null==e?void 0:e.message)?String(e.message):String(e);Q({kind:"err",text:`Errore salvataggio: ${t}`})}}),disabled:Y,style:P(S.respingi,!!Y,x),children:Y?"Aggiorno\u2026":"Conferma respinta"}),"TRASMETTI"===ee&&(0,e.jsx)(i.Button,{type:"primary",onClick:()=>o(this,void 0,void 0,function*(){try{yield nt({[q]:_,[V]:Date.now(),[Z]:T},"Trasmesso a DA."),te(null),ne(!1)}catch(e){const t=(null==e?void 0:e.message)?String(e.message):String(e);Q({kind:"err",text:`Errore salvataggio: ${t}`})}}),disabled:Y,style:P(S.trasmetti,!!Y,x),children:Y?"Aggiorno\u2026":"Conferma trasmissione"}),(0,e.jsx)(i.Button,{type:"default",onClick:()=>{te(null),K(!1),Q(null),ne(!1),oe(de.current),ae("")},disabled:Y,children:"Annulla"})]})]}),Pe&&ye&&(0,e.jsx)("div",{style:Object.assign(Object.assign({},h("info",$)),{marginTop:4}),children:"Pratica gi\xe0 trasmessa a DA: azioni non disponibili."})]})]})}function L(e){if(null==e||""===e)return"\u2014";try{const t=Number(e),i=Number.isFinite(t)&&t>0?new Date(t):new Date(String(e));if(Number.isNaN(i.getTime()))return String(e);const n=String(i.getDate()).padStart(2,"0"),l=String(i.getMonth()+1).padStart(2,"0"),o=String(i.getFullYear()),r=String(i.getHours()).padStart(2,"0");return`${n}/${l}/${o} ${r}:${String(i.getMinutes()).padStart(2,"0")}`}catch(t){return String(e)}}function W(e){if(!e)return[];const t=(null==e?void 0:e.asMutable)?e.asMutable({deep:!0}):e;return(Array.isArray(t)?t:[]).map(e=>String(e)).filter(Boolean)}function M(e,t){let i=[];return i=Array.isArray(t)&&t.length>0?t.map(e=>{let t=[];return e.fields&&(Array.isArray(e.fields)?t=e.fields.map(String).filter(Boolean):"function"==typeof e.fields.toArray?t=e.fields.toArray().map(String).filter(Boolean):"function"==typeof e.fields.toJS?t=e.fields.toJS().map(String).filter(Boolean):"function"==typeof e.fields[Symbol.iterator]&&(t=Array.from(e.fields).map(String).filter(Boolean))),Object.assign(Object.assign({},e),{fields:t})}):[{id:"anagrafica",label:"Anagrafica",fields:(null==e?void 0:e.anagrafica)||[]},{id:"violazione",label:"Violazione",fields:(null==e?void 0:e.violazione)||[]},{id:"iter",label:"Iter",fields:(null==e?void 0:e.iterExtra)||[],isIterTab:!0},{id:"allegati",label:"Allegati",fields:(null==e?void 0:e.allegati)||[]},{id:"azioni",label:"Azioni",fields:[]}],i.map(e=>{const t=null!=e.hideEmpty?Boolean(e.hideEmpty):"violazione"===e.id||"allegati"===e.id;if("azioni"===e.id){const t=e,{locked:i}=t,n=d(t,["locked"]);return Object.assign(Object.assign({},n),{hideEmpty:!1})}return Object.assign(Object.assign({},e),{hideEmpty:t})})}function G(t){const i=t.active?"#eaf2ff":"rgba(0,0,0,0.02)",n=t.active?"#2f6fed":"rgba(0,0,0,0.12)",l=t.active?"#1d4ed8":"#111827";return(0,e.jsx)("button",{type:"button",disabled:!!t.disabled,onClick:t.onClick,style:{padding:"8px 10px",borderRadius:10,border:`1px solid ${n}`,background:i,color:l,fontWeight:700,fontSize:12,cursor:t.disabled?"not-allowed":"pointer",opacity:t.disabled?.55:1},children:t.label})}function J(t){var i;const n=null!==(i=t.ui)&&void 0!==i?i:{},l=Number.isFinite(Number(n.titleFontSize))?Number(n.titleFontSize):14,o=Number.isFinite(Number(n.msgFontSize))?Number(n.msgFontSize):12;Number.isFinite(Number(n.statusFontSize))&&Number(n.statusFontSize);return(0,e.jsxs)("div",{style:{width:"100%",height:"100%",boxSizing:"border-box",display:"flex",flexDirection:"column",minHeight:0},children:[(0,e.jsx)("div",{style:{fontWeight:800,fontSize:l,marginBottom:10},children:t.title}),t.rows.length?(0,e.jsx)("div",{style:{display:"grid",gap:8},children:t.rows.map((t,i)=>(0,e.jsx)(w,{label:t.label,value:t.value,labelSize:12,valueSize:13},i))}):(0,e.jsx)("div",{style:Object.assign({},h("info",o)),children:t.emptyText||"Configura i campi nelle impostazioni."})]})}function U(i){var n,l,r,a,d,s,g,y,m,h,S,x,j;const{active:w,ui:R}=i,T=t.React.useMemo(()=>M(i.tabFields,i.tabs),[i.tabs,i.tabFields]),I=(null!=(null===(n=null==w?void 0:w.state)||void 0===n?void 0:n.oid)&&(w.key,w.state.oid),null===(l=null==w?void 0:w.state)||void 0===l?void 0:l.ds),z=(null===(r=null==w?void 0:w.state)||void 0===r?void 0:r.data)||null,_=null!==(d=null===(a=null==w?void 0:w.state)||void 0===a?void 0:a.oid)&&void 0!==d?d:null,N=null!=_&&Number.isFinite(_),A=t.React.useMemo(()=>{var e,t;if(!N||!z)return"";const i=null!==(t=null!==(e=z.origine_pratica)&&void 0!==e?e:z.Origine_pratica)&&void 0!==t?t:z.ORIGINE_PRATICA;let n="TR";return 2===i||"2"===i||"TI"===String(i).toUpperCase()?n="TI":1!==i&&"1"!==i&&"TR"!==String(i).toUpperCase()||(n="TR"),`${n}-${_}`},[N,z,_]),[C,F]=t.React.useState((null===(s=T[0])||void 0===s?void 0:s.id)||"anagrafica"),D=N&&null!=_?Number(_):null,[k,B]=t.React.useState(null),[E,O]=t.React.useState([]),[P,W]=t.React.useState(!1),[U,H]=t.React.useState(null),q=t.React.useCallback(e=>{if(null==e||isNaN(Number(e)))return"";const t=Number(e);if(t<1024)return`${t} B`;const i=t/1024;if(i<1024)return`${i.toFixed(1)} KB`;const n=i/1024;if(n<1024)return`${n.toFixed(1)} MB`;return`${(n/1024).toFixed(1)} GB`},[]),V=t.React.useCallback(()=>o(this,void 0,void 0,function*(){if(D)try{W(!0),H(null);const e=I,i=yield function(e){return o(this,void 0,void 0,function*(){var i,n,l,o,r,a,d;if(!e)return null;const s=[],g=e=>{e&&!s.includes(e)&&s.push(e)};g(e);try{const i=t.DataSourceManager.getInstance();g((null==e?void 0:e.id)?i.getDataSource(e.id):null);const n=null==e?void 0:e.belongToDataSource;"string"==typeof n&&n&&g(i.getDataSource(n))}catch(e){}for(const e of s){const t=e,o=u(null!==(l=null!==(n=null!==(i="function"==typeof t.getLayer?t.getLayer():null)&&void 0!==i?i:"function"==typeof t.getJsApiLayer?t.getJsApiLayer():null)&&void 0!==n?n:"function"==typeof t.getJSAPILayer?t.getJSAPILayer():null)&&void 0!==l?l:t.layer);if(o&&"function"==typeof o.queryAttachments)return o}try{const t=e,i=null!==(a=null===(r=null===(o=null==t?void 0:t.getDataSourceJson)||void 0===o?void 0:o.call(t))||void 0===r?void 0:r.url)&&void 0!==a?a:null===(d=null==t?void 0:t.dataSourceJson)||void 0===d?void 0:d.url;if(!i||"string"!=typeof i)return null;const n=new(yield c("esri/layers/FeatureLayer"))({url:i});if("function"==typeof(null==n?void 0:n.load)&&(yield n.load().catch(()=>{})),n&&"function"==typeof n.queryAttachments)return n}catch(e){}return null})}(e);if(!i)return O([]),B(D),void H("Non riesco a risalire al FeatureLayer per leggere gli allegati (datasource/vista non espone il layer JS API).");const n=yield i.queryAttachments({objectIds:[D],returnMetadata:!0,returnUrl:!0}),l=e=>e?Array.isArray(e)?e:Array.isArray(e.attachmentInfos)?e.attachmentInfos:Array.isArray(e.attachments)?e.attachments:[]:[];let r=[];if(Array.isArray(n))for(const e of n){if(!e)continue;if((null!=e.parentObjectId?e.parentObjectId:null!=e.objectId?e.objectId:null)===D){r=l(e);break}}else if(n&&"object"==typeof n)if(Array.isArray(n.attachmentGroups))for(const e of n.attachmentGroups){if((e&&null!=e.parentObjectId?e.parentObjectId:e&&null!=e.objectId?e.objectId:null)===D){r=l(e);break}}else n[D]?r=l(n[D]):n[String(D)]?r=l(n[String(D)]):n.attachmentInfos&&(r=l(n));const a=(r||[]).map(e=>({id:Number(e.id),name:e.name,size:e.size,contentType:e.contentType,url:e.url})).filter(e=>e&&!isNaN(e.id));O(a),B(D)}catch(e){O([]),B(D),H((null==e?void 0:e.message)||String(e))}finally{W(!1)}}),[I,D]);t.React.useEffect(()=>{"allegati"===C&&null!=D&&k!==D&&V()},[C,D,k]);const[Z,Y]=t.React.useState({}),[K,X]=t.React.useState(!1);t.React.useEffect(()=>{var e;let t=!1;X(!1);try{const i=null===(e=null==I?void 0:I.getSchema)||void 0===e?void 0:e.call(I),n=(null==i?void 0:i.fields)||{},l={};for(const e of Object.keys(n)){const t=n[e],i=String((null==t?void 0:t.alias)||(null==t?void 0:t.label)||(null==t?void 0:t.title)||e);l[e]=i}!t&&Object.keys(l).length&&(Y(l),X(!0))}catch(e){}return(()=>{o(this,void 0,void 0,function*(){var e,i,n;if(I)try{const l=(null===(e=null==I?void 0:I.getLayer)||void 0===e?void 0:e.call(I))||(null===(i=null==I?void 0:I.getJSAPILayer)||void 0===i?void 0:i.call(I))||(null==I?void 0:I.layer)||(null===(n=null==I?void 0:I.createJSAPILayerByDataSource)||void 0===n?void 0:n.call(I))||null,o=u(yield Promise.resolve(l)),r=(null==o?void 0:o.fields)||[],a={};for(const e of r){const t=String((null==e?void 0:e.name)||"");t&&(a[t]=String((null==e?void 0:e.alias)||(null==e?void 0:e.label)||(null==e?void 0:e.title)||t))}t||(Object.keys(a).length&&Y(a),X(!0))}catch(e){t||X(!0)}else t||(Y({}),X(!0))})})(),()=>{t=!0}},[I]);const Q=t.React.useCallback(e=>{const t=null==Z?void 0:Z[e];return K?t?`${t}`:e:""},[Z,K]),ee=t.React.useCallback((e,t)=>b(e,t),[]),te=t.React.useCallback(e=>{const t=`${f(e)} ${f((null==Z?void 0:Z[e])||"")}`.trim(),i=p(t,"nome")||t.startsWith("nome "),n=p(t,"cognome")||t.startsWith("cognome "),l=p(t,"cf")||p(t,"c f")||p(t,"c f ")||p(t,"codice fiscale")||t.includes("cod")&&t.includes("fisc");return Boolean(i||n||l)},[Z]),ie=t.React.useCallback(e=>{const t=`${f(e)} ${f((null==Z?void 0:Z[e])||"")}`.trim(),i=p(t,"ragione sociale")||p(t,"denominazione")||t.includes("ragione")&&t.includes("social"),n=p(t,"partita iva")||p(t,"p iva")||p(t,"piva")||t.includes("partita")&&t.includes("iva");return Boolean(i||n)},[Z]),ne=t.React.useCallback((e,t,i)=>{let n=[];e&&(Array.isArray(e)?n=e.map(String).filter(Boolean):"function"==typeof e.toArray?n=e.toArray().map(String).filter(Boolean):"function"==typeof e.toJS?n=e.toJS().map(String).filter(Boolean):"function"==typeof e[Symbol.iterator]&&(n=Array.from(e).map(String).filter(Boolean)));const l=n.length?n:function(e,t){if(!e)return[];const i=Object.keys(e).filter(e=>!/^objectid$/i.test(e)&&!/^globalid$/i.test(e)&&!/^shape/i.test(e)),n=e=>i.filter(t=>e.test(t));if("ANAGRAFICA"===t)return n(/ditta|denom|ragione|nome|cognome|cf|cod.*fisc|piva|partita|indir|via|cap|comune|prov|telefono|cell|mail|pec/i).slice(0,16);if("VIOLAZIONE"===t)return n(/viol|infraz|descr|art|norm|tipo|sanz|import|acqua|volume|turno|utenza|contatore/i).slice(0,16);if("ALLEGATI"===t)return n(/alleg|foto|doc|file|url|link|pdf|jpg|png/i).slice(0,16);return[]}(z,t),o=z&&null!=z.__tipo_soggetto_raw?z.__tipo_soggetto_raw:z&&null!=z.tipo_soggetto?z.tipo_soggetto:null,r=z&&null!=z.__tipo_soggetto_label?z.__tipo_soggetto_label:null,a="ANAGRAFICA"===t?ee(o,r):null,d="ANAGRAFICA"===t&&a?l.filter(e=>!!e&&(("PF"!==a||!ie(e))&&("PG"!==a||!te(e)))):l,s=[];for(const e of d){if(!e)continue;const t=z?z[e]:null;i&&v(t)||s.push({label:Q(e),value:t})}return s},[z,Q,ee,te,ie]),le=z?z.presa_in_carico_DT:null,oe=z?z.dt_presa_in_carico_DT:null,re=z?z.stato_DT:null,ae=z?z.dt_stato_DT:null,de=z?z.esito_DT:null,se=z?z.dt_esito_DT:null,ue=z?z.note_DT:null,ce=z?z.presa_in_carico_DA:null,ge=z?z.dt_presa_in_carico_DA:null,fe=z?z.stato_DA:null,ve=z?z.dt_stato_DA:null,pe=z?z.esito_DA:null,be=z?z.dt_esito_DA:null,ye=z?z.note_DA:null,me=(0,e.jsx)("div",{style:{display:"flex",flexWrap:"wrap",gap:8,padding:"8px 12px",alignItems:"center",borderBottom:"1px solid rgba(0,0,0,0.08)",background:"var(--bs-body-bg, #fff)",marginTop:-R.panelPadding,marginLeft:-R.panelPadding,marginRight:-R.panelPadding,width:`calc(100% + ${2*R.panelPadding}px)`,borderTopLeftRadius:R.panelBorderRadius,borderTopRightRadius:R.panelBorderRadius},children:N&&T.map(t=>(0,e.jsx)(G,{active:C===t.id,label:t.label,onClick:()=>F(t.id)},t.id))}),he={width:"100%",height:"100%",flex:"1 1 auto",display:"flex",flexDirection:"column",minHeight:0,boxSizing:"border-box",background:R.panelBg,border:`${R.panelBorderWidth}px solid ${R.panelBorderColor}`,borderRadius:R.panelBorderRadius,padding:R.panelPadding};let Se=null;if(N){const t=T.find(e=>e.id===C);if("azioni"===(null==t?void 0:t.id))Se=(0,e.jsx)($,{active:w,roleCode:i.roleCode,buttonText:i.buttonText,buttonColors:i.buttonColors,ui:i.ui,editConfig:i.editConfig,motherLayerUrl:i.motherLayerUrl});else if(null==t?void 0:t.isIterTab){const i=[];i.push({label:"DT - Presa in carico",value:le}),i.push({label:"DT - Data presa in carico",value:L(oe)}),i.push({label:"DT - Stato",value:re}),i.push({label:"DT - Data stato",value:L(ae)}),i.push({label:"DT - Esito",value:de}),i.push({label:"DT - Data esito",value:L(se)}),i.push({label:"DT - Note",value:ue}),i.push({label:"DA - Presa in carico",value:ce}),i.push({label:"DA - Data presa in carico",value:L(ge)}),i.push({label:"DA - Stato",value:fe}),i.push({label:"DA - Data stato",value:L(ve)}),i.push({label:"DA - Esito",value:pe}),i.push({label:"DA - Data esito",value:L(be)}),i.push({label:"DA - Note",value:ye});(K?ne(t.fields,t.id.toUpperCase(),Boolean(t.hideEmpty)):[]).forEach(e=>i.push(e)),Se=(0,e.jsx)(J,{title:t.label,ui:R,rows:i})}else if(t){const i=K?ne(t.fields,t.id.toUpperCase(),Boolean(t.hideEmpty)):[];if("allegati"===t.id){const n=I,l=u((n&&"function"==typeof n.getLayer?n.getLayer():null)||(n&&"function"==typeof n.getJsApiLayer?n.getJsApiLayer():null)||n&&n.layer||n),o=l&&l.url?String(l.url):"",r=e=>e&&e.url?String(e.url):o&&null!=D&&e&&null!=e.id?`${o}/${D}/attachments/${e.id}`:null;Se=(0,e.jsxs)("div",{style:{marginTop:8},children:[(0,e.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:10},children:[(0,e.jsx)("div",{style:{fontWeight:700,fontSize:13},children:"Allegati"}),(0,e.jsx)("button",{type:"button",onClick:()=>V(),disabled:!N||P,onMouseEnter:e=>{N&&!P&&(e.currentTarget.style.background="#eaf2ff",e.currentTarget.style.borderColor="#2f6fed",e.currentTarget.style.color="#1d4ed8")},onMouseLeave:e=>{N&&!P&&(e.currentTarget.style.background="#fff",e.currentTarget.style.borderColor="rgba(0,0,0,0.12)",e.currentTarget.style.color="#111827")},style:{padding:"6px 10px",borderRadius:10,border:"1px solid rgba(0,0,0,0.12)",background:"#fff",color:"#111827",cursor:!N||P?"not-allowed":"pointer",fontSize:12,fontWeight:600,transition:"all 0.15s ease"},children:"Aggiorna"})]}),!N&&(0,e.jsx)("div",{style:{opacity:.75,fontSize:12},children:"Selezionare un rapporto per vedere gli allegati."}),N&&P&&(0,e.jsx)("div",{style:{opacity:.75,fontSize:12},children:"Caricamento allegati\u2026"}),N&&!P&&U&&(0,e.jsx)("div",{style:{color:"#b00020",fontSize:12},children:U}),N&&!P&&!U&&(0,e.jsx)("div",{style:{display:"flex",flexDirection:"column",gap:8},children:E&&E.length?E.map(t=>{const i=r(t),n=[t.contentType,q(t.size)].filter(Boolean).join(" \u2022 ");return(0,e.jsxs)("div",{style:{border:"1px solid rgba(0,0,0,0.08)",borderRadius:12,padding:"8px 10px",display:"flex",alignItems:"center",justifyContent:"space-between",gap:10},children:[(0,e.jsxs)("div",{style:{minWidth:0},children:[(0,e.jsx)("div",{style:{fontWeight:600,fontSize:12,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:t.name||`Allegato #${t.id}`}),n?(0,e.jsx)("div",{style:{opacity:.7,fontSize:11},children:n}):null]}),i?(0,e.jsx)("a",{href:i,target:"_blank",rel:"noreferrer",onMouseEnter:e=>{e.currentTarget.style.background="#eaf2ff",e.currentTarget.style.borderColor="#2f6fed",e.currentTarget.style.color="#1d4ed8"},onMouseLeave:e=>{e.currentTarget.style.background="#fff",e.currentTarget.style.borderColor="rgba(0,0,0,0.12)",e.currentTarget.style.color="#111827"},style:{padding:"6px 10px",borderRadius:10,border:"1px solid rgba(0,0,0,0.12)",background:"#fff",color:"#111827",textDecoration:"none",fontSize:12,fontWeight:600,whiteSpace:"nowrap",transition:"all 0.15s ease"},children:"Apri"}):(0,e.jsx)("span",{style:{opacity:.6,fontSize:12,whiteSpace:"nowrap"},children:"URL non disponibile"})]},t.id)}):(0,e.jsx)("div",{style:{opacity:.75,fontSize:12},children:"Nessun allegato."})}),i&&i.length>0&&(0,e.jsxs)("div",{style:{marginTop:12},children:[(0,e.jsx)("div",{style:{fontWeight:700,fontSize:13,marginBottom:6},children:"Attributi"}),(0,e.jsx)(J,{title:t.label,rows:i,emptyText:N?"Nessun campo configurato per questa tab.":"Selezionare un rapporto."})]})]})}else Se=(0,e.jsx)(J,{title:t.label,rows:i,emptyText:N?"Nessun campo configurato per questa tab.":"Selezionare un rapporto."})}}else Se=(0,e.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",height:"100%",minHeight:200,fontWeight:700,fontSize:14,color:"rgba(0,0,0,0.6)"},children:"Selezionare un rapporto nell\u2019elenco"});return(0,e.jsxs)("div",{style:{width:"100%",height:"100%",display:"flex",flexDirection:"column",minHeight:0,boxSizing:"border-box"},children:[(0,e.jsx)("div",{style:{height:null!==(g=R.detailTitleHeight)&&void 0!==g?g:28,paddingBottom:null!==(y=R.detailTitlePaddingBottom)&&void 0!==y?y:10,paddingLeft:null!==(m=R.detailTitlePaddingLeft)&&void 0!==m?m:0,display:"flex",alignItems:"center",boxSizing:"border-box",flex:"0 0 auto",background:R.detailTitleBg&&"transparent"!==R.detailTitleBg?R.detailTitleBg:void 0},children:(0,e.jsxs)("span",{style:{fontSize:null!==(h=R.detailTitleFontSize)&&void 0!==h?h:14,fontWeight:null!==(S=R.detailTitleFontWeight)&&void 0!==S?S:600,color:N&&A?null!==(x=R.detailTitleColor)&&void 0!==x?x:"rgba(0,0,0,0.85)":"rgba(0,0,0,0.40)"},children:[String(null!==(j=R.detailTitlePrefix)&&void 0!==j?j:"Dettaglio rapporto n.")," ",N&&A?A:"\u2013"]})}),(0,e.jsxs)("div",{style:he,children:[(0,e.jsx)("div",{style:{flex:"0 0 auto"},children:me}),(0,e.jsx)("div",{style:{flex:"1 1 auto",minHeight:0,overflowY:"auto"},children:Se})]})]})}function H(i){var n,r,a,d,s,u,c,g,f,v,p,b,y,m,h,j,w,R,T,I,z,_,N;const A=i.config&&i.config.asMutable?i.config.asMutable({deep:!0}):i.config||{},C=Object.assign(Object.assign({},l),A),[F,D]=t.React.useState("");t.React.useEffect(()=>{var e;try{const t=null===(e=window.__giiUserRole)||void 0===e?void 0:e.ruoloLabel;t&&"ADMIN"!==t&&D(String(t).toUpperCase())}catch(e){}let t=0;const i=setInterval(()=>{var e;t++;try{const t=null===(e=window.__giiUserRole)||void 0===e?void 0:e.ruoloLabel;t&&"ADMIN"!==t&&(D(String(t).toUpperCase()),clearInterval(i))}catch(e){}t>=20&&clearInterval(i)},500);return()=>clearInterval(i)},[]);const k=F||String(C.roleCode||"DT").toUpperCase(),B=String(C.buttonText||"Prendi in carico"),E={take:O(C.takeColor,l.takeColor),integrazione:O(C.integrazioneColor,l.integrazioneColor),approva:O(C.approvaColor,l.approvaColor),respingi:O(C.respingiColor,l.respingiColor),trasmetti:O(C.trasmettiColor,l.trasmettiColor)},P={panelBg:String(null!==(a=null!==(r=null!==(n=C.maskBg)&&void 0!==n?n:C.panelBg)&&void 0!==r?r:l.maskBg)&&void 0!==a?a:l.panelBg),panelBorderColor:String(null!==(u=null!==(s=null!==(d=C.maskBorderColor)&&void 0!==d?d:C.panelBorderColor)&&void 0!==s?s:l.maskBorderColor)&&void 0!==u?u:l.panelBorderColor),panelBorderWidth:Number.isFinite(Number(null!==(c=C.maskBorderWidth)&&void 0!==c?c:C.panelBorderWidth))?Number(null!==(g=C.maskBorderWidth)&&void 0!==g?g:C.panelBorderWidth):null!==(f=l.maskBorderWidth)&&void 0!==f?f:l.panelBorderWidth,panelBorderRadius:Number.isFinite(Number(null!==(v=C.maskBorderRadius)&&void 0!==v?v:C.panelBorderRadius))?Number(null!==(p=C.maskBorderRadius)&&void 0!==p?p:C.panelBorderRadius):null!==(b=l.maskBorderRadius)&&void 0!==b?b:l.panelBorderRadius,panelPadding:Number.isFinite(Number(null!==(y=C.maskInnerPadding)&&void 0!==y?y:C.panelPadding))?Number(null!==(m=C.maskInnerPadding)&&void 0!==m?m:C.panelPadding):null!==(h=l.maskInnerPadding)&&void 0!==h?h:l.panelPadding,dividerColor:String(null!==(j=C.dividerColor)&&void 0!==j?j:l.dividerColor),titleFontSize:Number.isFinite(Number(C.titleFontSize))?Number(C.titleFontSize):l.titleFontSize,statusFontSize:Number.isFinite(Number(C.statusFontSize))?Number(C.statusFontSize):l.statusFontSize,msgFontSize:Number.isFinite(Number(C.msgFontSize))?Number(C.msgFontSize):l.msgFontSize,rejectReasons:Array.isArray(C.rejectReasons)?C.rejectReasons.map(e=>String(e)):l.rejectReasons,reasonsZebraOddBg:String(null!==(w=C.reasonsZebraOddBg)&&void 0!==w?w:l.reasonsZebraOddBg),reasonsZebraEvenBg:String(null!==(R=C.reasonsZebraEvenBg)&&void 0!==R?R:l.reasonsZebraEvenBg),reasonsRowBorderColor:String(null!==(T=C.reasonsRowBorderColor)&&void 0!==T?T:l.reasonsRowBorderColor),reasonsRowBorderWidth:Number.isFinite(Number(C.reasonsRowBorderWidth))?Number(C.reasonsRowBorderWidth):l.reasonsRowBorderWidth,reasonsRowRadius:Number.isFinite(Number(C.reasonsRowRadius))?Number(C.reasonsRowRadius):l.reasonsRowRadius,detailTitlePrefix:String(null!==(I=C.detailTitlePrefix)&&void 0!==I?I:l.detailTitlePrefix),detailTitleHeight:Number.isFinite(Number(C.detailTitleHeight))?Number(C.detailTitleHeight):l.detailTitleHeight,detailTitlePaddingBottom:Number.isFinite(Number(C.detailTitlePaddingBottom))?Number(C.detailTitlePaddingBottom):l.detailTitlePaddingBottom,detailTitlePaddingLeft:Number.isFinite(Number(C.detailTitlePaddingLeft))?Number(C.detailTitlePaddingLeft):l.detailTitlePaddingLeft,detailTitleFontSize:Number.isFinite(Number(C.detailTitleFontSize))?Number(C.detailTitleFontSize):l.detailTitleFontSize,detailTitleFontWeight:Number.isFinite(Number(C.detailTitleFontWeight))?Number(C.detailTitleFontWeight):l.detailTitleFontWeight,detailTitleColor:String(null!==(z=C.detailTitleColor)&&void 0!==z?z:l.detailTitleColor),detailTitleBg:String(null!==(_=C.detailTitleBg)&&void 0!==_?_:"transparent"),btnBorderRadius:Number.isFinite(Number(C.btnBorderRadius))?Number(C.btnBorderRadius):8,btnFontSize:Number.isFinite(Number(C.btnFontSize))?Number(C.btnFontSize):13,btnFontWeight:Number.isFinite(Number(C.btnFontWeight))?Number(C.btnFontWeight):600,btnPaddingX:Number.isFinite(Number(C.btnPaddingX))?Number(C.btnPaddingX):16,btnPaddingY:Number.isFinite(Number(C.btnPaddingY))?Number(C.btnPaddingY):8},$={anagrafica:W(C.anagraficaFields),violazione:W(C.violazioneFields),allegati:W(C.allegatiFields),iterExtra:W(C.iterExtraFields)},L=M($,C.tabs||[]),G={show:!1!==C.showEditButtons,overlayColor:O(C.editOverlayColor,"#7c3aed"),pageColor:O(C.editPageColor,"#5b21b6"),pageId:String(C.editPageId||"editing-ti"),fieldStatoTI:String(C.fieldStatoTI||"stato_TI"),fieldPresaTI:String(C.fieldPresaTI||"presa_in_carico_TI"),minStato:Number.isFinite(Number(C.editMinStato))?Number(C.editMinStato):2,maxStato:Number.isFinite(Number(C.editMaxStato))?Number(C.editMaxStato):2,presaRequiredVal:Number.isFinite(Number(C.editPresaRequiredVal))?Number(C.editPresaRequiredVal):2},J=i.useDataSources||[],H=Array.isArray(J)&&J.length>0,q=["presa_in_carico_DT","dt_presa_in_carico_DT","stato_DT","dt_stato_DT","esito_DT","dt_esito_DT","note_DT","presa_in_carico_DA","dt_presa_in_carico_DA","stato_DA","dt_stato_DA","esito_DA","dt_esito_DA","note_DA"],V=t.React.useMemo(()=>{const e=new Set;let t=!1;const i=(null==L?void 0:L.asMutable)?L.asMutable({deep:!0}):Array.isArray(L)?L:[];for(const n of i){if(!n||"azioni"===n.id)continue;const i=W(n.fields);i.length||"iter"===n.id||(t=!0);for(const t of i)e.add(String(t))}for(const t of q)e.add(String(t));const n=Array.from(e).filter(Boolean);return t?["*"]:n},[L,q.join("|")]),[Z,Y]=t.React.useState({}),[K,X]=t.React.useState(null),Q=t.React.useCallback((e,t)=>{Y(i=>{const n=i[e];return n&&n.sig===t.sig&&n.ds===t.ds&&n.idFieldName===t.idFieldName?i:Object.assign(Object.assign({},i),{[e]:t})}),null!=t.oid&&X(e)},[]),[ee,te]=(t.React.useMemo(()=>{var e;if(K&&null!=(null===(e=Z[K])||void 0===e?void 0:e.oid))return{key:K,state:Z[K]};for(let e=0;e<J.length;e++){const t=S(J[e],e),i=Z[t];if(i&&null!=i.oid)return{key:t,state:i}}return null},[J,Z,K]),t.React.useState(null));t.React.useEffect(()=>{try{sessionStorage.removeItem("GII_SELECTED_OID")}catch(e){}const e=()=>{try{const e=sessionStorage.getItem("GII_SELECTED_OID"),t=null!=e?Number(e):NaN;te(Number.isFinite(t)?t:null)}catch(e){te(null)}};return window.addEventListener("gii-selection-changed",e),()=>window.removeEventListener("gii-selection-changed",e)},[]);const[ie,ne]=t.React.useState(null),le=t.React.useRef(0);t.React.useEffect(()=>{const e=++le.current;null!=ee?(()=>{o(this,void 0,void 0,function*(){var i,n,l,o,r,a;for(let d=0;d<J.length;d++){const s=J[d],u=S(s,d),c=String((null==s?void 0:s.dataSourceId)||"");if(!c)continue;let g=null;try{g=t.DataSourceManager.getInstance().getDataSource(c)}catch(e){}if(!g||!g.query)continue;const f=(null===(i=g.getIdField)||void 0===i?void 0:i.call(g))||(null===(l=null===(n=g.getSchema)||void 0===n?void 0:n.call(g))||void 0===l?void 0:l.idField)||"OBJECTID";try{const t=`${f}=${ee}`,i=yield g.query({where:t,outFields:V,returnGeometry:!1});if(e!==le.current)return;const n=(null==i?void 0:i.records)||[];if(!n.length)continue;const l=n[0],d=(null===(o=null==l?void 0:l.getData)||void 0===o?void 0:o.call(l))||{},s=Number(null!==(a=null!==(r=d[f])&&void 0!==r?r:d.OBJECTID)&&void 0!==a?a:ee);if(!Number.isFinite(s)||s!==ee)continue;return void ne({key:u,state:{ds:g,oid:ee,idFieldName:f,data:d,sig:`${c}:${ee}`}})}catch(e){}}e===le.current&&ne(null)})})():ne(null)},[ee,J,V.join("|")]);const oe=ie;return(0,e.jsx)("div",{style:{width:"100%",height:"100%",display:"flex",flexDirection:"column",minHeight:0,boxSizing:"border-box",padding:Number.isFinite(Number(null!==(N=C.maskOuterOffset)&&void 0!==N?N:0))?Number(C.maskOuterOffset):0},children:H?(0,e.jsxs)(e.Fragment,{children:[J.map((t,n)=>{const l=S(t,n);return(0,e.jsx)(x,{widgetId:i.id,uds:t,dsKey:l,watchFields:q,queryFields:V,onUpdate:Q},l)}),(0,e.jsx)(U,{active:oe,roleCode:k,buttonText:B,buttonColors:E,ui:P,tabFields:$,tabs:L,editConfig:G,motherLayerUrl:String(C.motherLayerUrl||"").trim()||void 0})]}):(0,e.jsx)("div",{children:"Configura il data source nelle impostazioni del widget."})})}function q(e){r.p=e}})(),a})())}}});