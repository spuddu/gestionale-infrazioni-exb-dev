System.register(["jimu-core/emotion","jimu-core","jimu-arcgis","esri/Graphic"],function(e,t){var i={},a={},o={},s={};return{setters:[function(e){i.jsx=e.jsx,i.jsxs=e.jsxs},function(e){a.DataSourceManager=e.DataSourceManager,a.React=e.React},function(e){o.JimuMapViewComponent=e.JimuMapViewComponent},function(e){s.default=e.default}],execute:function(){e((()=>{var e={244:e=>{"use strict";e.exports=a},386:e=>{"use strict";e.exports=i},470:e=>{"use strict";e.exports=s},686:e=>{"use strict";e.exports=o}},t={};function r(i){var a=t[i];if(void 0!==a)return a.exports;var o=t[i]={exports:{}};return e[i](o,o.exports,r),o.exports}r.d=(e,t)=>{for(var i in t)r.o(t,i)&&!r.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.p="";var n={};return r.p=window.jimuConfig.baseUrl,(()=>{"use strict";r.r(n),r.d(n,{__set_webpack_public_path__:()=>c,default:()=>s});var e=r(386),t=r(244),i=r(686),a=r(470),o=function(e,t,i,a){return new(i||(i=Promise))(function(o,s){function r(e){try{c(a.next(e))}catch(e){s(e)}}function n(e){try{c(a.throw(e))}catch(e){s(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i(function(e){e(t)})).then(r,n)}c((a=a.apply(e,t||[])).next())})};class s extends t.React.PureComponent{constructor(e){super(e),this.mapView=null,this.userRoleCheckInterval=null,this.startUserRoleCheck=()=>{const e=()=>{const e=window.__giiUserRole;e&&JSON.stringify(e)!==JSON.stringify(this.state.giiUserRole)&&(console.log("\u{1f4cb} Elenco: rilevato ruolo da window:",e),this.setState({giiUserRole:e}))};e(),this.userRoleCheckInterval=setInterval(e,2e3)},this.getDataSourceForRole=()=>{const{giiUserRole:e}=this.state;if(!e)return null;const t=e.ruolo,i=e.settore,a=e.area;if(t>=1&&t<=3)if(1===a){if(1===i)return"dataSource_39";if(2===i)return"dataSource_38";if(3===i)return"dataSource_37";if(4===i)return"dataSource_36";if(5===i)return"dataSource_35";if(6===i)return"dataSource_34"}else if(2===a)return"dataSource_33";return 4===t||5===t?"dataSource_41":6===t||7===t?"dataSource_40":8===t?"dataSource_32":99===t?"dataSource_31":null},this.loadAllPractices=()=>o(this,void 0,void 0,function*(){this.setState({isLoading:!0});const{useDataSources:e}=this.props;if(!e||0===e.length)return console.warn("\u26a0\ufe0f Nessun data source configurato"),void this.setState({isLoading:!1});const t=[],i=this.getDataSourceForRole();if(i){const a=e.find(e=>e.dataSourceId===i);if(a){const e=this.dataSourceManager.getDataSource(a.dataSourceId);if(e)try{console.log(`\u{1f4ca} Carico pratiche da: ${i}`);const o=yield e.query({where:"1=1",outFields:["*"],returnGeometry:!1,num:1e3});(null==o?void 0:o.records)&&t.push(...o.records.map(e=>Object.assign(Object.assign({},e.feature.attributes),{_dataSourceId:a.dataSourceId,_dataSourceLabel:i})))}catch(e){console.error(`\u274c Errore caricamento ${a.dataSourceId}:`,e)}else console.warn(`\u26a0\ufe0f Datasource ${i} non trovato`)}else console.warn(`\u26a0\ufe0f Datasource ${i} non configurato nell'app`)}else console.warn("\u26a0\ufe0f Ruolo non rilevato o non valido");console.log(`\u2705 Caricate ${t.length} pratiche`),this.setState({practiceRecords:t,isLoading:!1})}),this.handlePracticeClick=e=>{const{config:t}=this.props;if((null==t?void 0:t.linkedWidgetId)&&e.OBJECTID){const t={type:"PRACTICE_SELECTED",practiceId:e.OBJECTID,practiceData:e};console.log("\u{1f4e4} Pubblicato:",t)}if(this.mapView&&e.Latitudine&&e.Longitudine){this.mapView.view.goTo({center:[e.Longitudine,e.Latitudine],zoom:16});const t=this.mapView.view.map.layers.find(t=>t.id===e._dataSourceId);if(t){const i=new a.default({geometry:{type:"point",longitude:e.Longitudine,latitude:e.Latitudine}});this.mapView.view.whenLayerView(t).then(e=>{this.mapView.view.popup.open({features:[i],location:i.geometry})})}}},this.onActiveViewChange=e=>{e&&(this.mapView=e)},this.getFilteredRecords=()=>{const{practiceRecords:e,activeRoleTab:t,giiUserRole:i}=this.state,a=(this.props.config||{}).statoRuoloField;let o=[...e];if(i&&a){const e=`stato_${i.ruoloLabel}`;"attesa_mia"===t?o=o.filter(t=>{const i=t[e];return 0===i||1===i||3===i}):"attesa_altri"===t&&(o=o.filter(t=>{const i=t[e];return 2===i||4===i}))}return o},this.sortRecords=e=>{const{giiUserRole:t}=this.state,i=(this.props.config||{}).statoRuoloField;if(!t||!i)return e;const a=`stato_${t.ruoloLabel}`;return e.slice().sort((e,t)=>{var i,o;const s=null!==(i=e[a])&&void 0!==i?i:999,r=null!==(o=t[a])&&void 0!==o?o:999,n=0===s||1===s||3===s,c=0===r||1===r||3===r;if(n&&!c)return-1;if(!n&&c)return 1;const l=e.Data_rilevazione?new Date(e.Data_rilevazione).getTime():0;return(t.Data_rilevazione?new Date(t.Data_rilevazione).getTime():0)-l})},this.dataSourceManager=t.DataSourceManager.getInstance(),this.state={practiceRecords:[],isLoading:!0,giiUserRole:null,activeRoleTab:"tutte",activeDataSourceTab:null}}componentDidMount(){return o(this,void 0,void 0,function*(){this.startUserRoleCheck(),yield this.loadAllPractices()})}componentWillUnmount(){this.userRoleCheckInterval&&clearInterval(this.userRoleCheckInterval)}componentDidUpdate(e,t){this.state.giiUserRole&&!t.giiUserRole&&this.loadAllPractices()}render(){const{config:t,useMapWidgetIds:a}=this.props,{isLoading:o,practiceRecords:s,giiUserRole:r,activeRoleTab:n}=this.state,c=r&&(null==t?void 0:t.statoRuoloField),l=this.getFilteredRecords(),u=this.sortRecords(l);return(0,e.jsxs)("div",{className:"widget-elenco-pratiche-pro",children:[(0,e.jsxs)("div",{className:"elenco-header",children:[(0,e.jsx)("h3",{children:"Elenco rapporti di rilevazione"}),(0,e.jsx)("div",{className:"counters",children:(0,e.jsxs)("div",{className:"counter",children:[(0,e.jsx)("span",{children:"Totali:"}),(0,e.jsx)("strong",{children:s.length})]})})]}),c&&(0,e.jsxs)("div",{className:"role-tabs",children:[(0,e.jsxs)("button",{className:"tutte"===n?"active":"",onClick:()=>this.setState({activeRoleTab:"tutte"}),children:["\u{1f464} ",r.ruoloLabel]}),(0,e.jsxs)("button",{className:"tutte"===n?"active":"",onClick:()=>this.setState({activeRoleTab:"tutte"}),children:["Tutte le pratiche ",s.length]}),(0,e.jsx)("button",{className:"attesa_mia"===n?"active":"",onClick:()=>this.setState({activeRoleTab:"attesa_mia"}),children:"In attesa mia"}),(0,e.jsx)("button",{className:"attesa_altri"===n?"active":"",onClick:()=>this.setState({activeRoleTab:"attesa_altri"}),children:"In attesa altri"})]}),(0,e.jsxs)("div",{className:"practices-list",children:[o&&(0,e.jsx)("div",{className:"loading",children:"Caricamento pratiche..."}),!o&&0===u.length&&(0,e.jsx)("div",{className:"no-data",children:"Nessuna pratica trovata"}),!o&&u.map((t,i)=>(0,e.jsxs)("div",{className:"practice-item",onClick:()=>this.handlePracticeClick(t),children:[(0,e.jsxs)("div",{className:"practice-header",children:[(0,e.jsx)("span",{className:"practice-number",children:t.N_pratica||"\u2014"}),(0,e.jsx)("span",{className:"practice-date",children:t.Data_rilevazione||"\u2014"}),(0,e.jsx)("span",{className:"practice-status",children:t.Stato_sintetico||"Non definito"})]}),(0,e.jsxs)("div",{className:"practice-details",children:[(0,e.jsxs)("span",{children:["Ufficio: ",t.Ufficio||"\u2014"]}),(0,e.jsxs)("span",{children:["Ultimo agg: ",t.Ultimo_agg||"\u2014"]})]})]},i))]}),a&&a.length>0&&(0,e.jsx)(i.JimuMapViewComponent,{useMapWidgetId:a[0],onActiveViewChange:this.onActiveViewChange})]})}}function c(e){r.p=e}})(),n})())}}});